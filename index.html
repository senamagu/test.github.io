<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CSBM-TRPG キャラシ&チャパレ出力</title>
  <style>
    :root { --bg:#0f1115; --panel:#171a21; --text:#e7e9ee; --muted:#a9b0bf; --line:#2a3040; --acc:#7aa2ff; }
    body{ margin:0; background:var(--bg); color:var(--text); font-family:system-ui, -apple-system, "Segoe UI", sans-serif; }
    header{ padding:16px 18px; border-bottom:1px solid var(--line); position:sticky; top:0; background:rgba(15,17,21,.92); backdrop-filter: blur(8px); z-index:10;}
    h1{ font-size:16px; margin:0 0 6px; }
    .sub{ color:var(--muted); font-size:12px; }
    main{ padding:16px 18px; max-width:1100px; margin:0 auto; display:grid; gap:14px; grid-template-columns: 1fr 1fr; }
    .card{ background:var(--panel); border:1px solid var(--line); border-radius:12px; padding:14px; }
    .card h2{ font-size:14px; margin:0 0 10px; }
    label{ display:block; font-size:12px; color:var(--muted); margin:8px 0 4px; }
    input, select, textarea, button{
      font:inherit; color:var(--text);
      background:#0f1219; border:1px solid var(--line);
      border-radius:10px; padding:9px 10px;
      outline:none;
    }
    textarea{ width:100%; min-height:140px; resize:vertical; }
    input[type="number"]{ width:100%; }
    .row{ display:grid; gap:10px; grid-template-columns: repeat(5, 1fr); }
    .row2{ display:grid; gap:10px; grid-template-columns: 1fr 1fr; }
    .row3{ display:grid; gap:10px; grid-template-columns: 1fr 1fr 1fr; }
    .row4{ display:grid; gap:10px; grid-template-columns: 2fr 1fr 1fr 1fr; }
    .btns{ display:flex; flex-wrap:wrap; gap:8px; margin-top:10px; }
    button{ cursor:pointer; }
    button.primary{ border-color:rgba(122,162,255,.45); background:rgba(122,162,255,.12); }
    button.danger{ border-color:rgba(255,90,90,.35); background:rgba(255,90,90,.10); }
    .mini{ font-size:12px; color:var(--muted); }
    .hint{ color:var(--muted); font-size:12px; line-height:1.5; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    .list{ display:grid; gap:8px; margin-top:10px; }
    .item{ display:grid; gap:8px; grid-template-columns: 1.6fr 1fr 1fr .8fr; align-items:center; }
    .item .del{ justify-self:end; }

    /* KPI: 名前を大きく・分かりやすく */
    .kpi{ display:grid; gap:10px; grid-template-columns: repeat(3, 1fr); }
    .kpi .box{ background:#0f1219; border:1px solid var(--line); border-radius:10px; padding:12px; }
    .kpi .name{ font-size:16px; font-weight:800; letter-spacing:.5px; }
    .kpi .v{ font-size:26px; font-weight:900; margin-top:6px; }
    .kpi .desc{ font-size:11px; color:var(--muted); margin-top:6px; line-height:1.4; }

    .full{ grid-column: 1 / -1; }
    @media (max-width: 960px){
      main{ grid-template-columns: 1fr; }
      .row{ grid-template-columns: repeat(2,1fr); }
      .kpi{ grid-template-columns: 1fr; }
      .item{ grid-template-columns: 1fr 1fr; }
      .item .del{ justify-self:start; }
      .row4{ grid-template-columns: 1fr 1fr; }
    }
    .pill{ display:inline-block; padding:3px 8px; border-radius:999px; border:1px solid var(--line); color:var(--muted); font-size:11px; margin-left:6px; }

    /* details */
    details{ border:1px solid var(--line); border-radius:10px; padding:8px 10px; background:#0f1219; }
    summary{ cursor:pointer; user-select:none; }
    summary::-webkit-details-marker{ display:none; }
    summary::before{
      content:"▶";
      display:inline-block;
      margin-right:8px;
      color:var(--muted);
      transform: translateY(-1px);
    }
    details[open] summary::before{ content:"▼"; }

    /* section separators inside cards */
    .subcard{
      border:1px solid var(--line);
      border-radius:12px;
      padding:12px;
      background:#0f1219;
      margin-top:10px;
    }
    .subcard h3{
      margin:0 0 8px;
      font-size:13px;
    }
    .caps{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      margin-top:8px;
    }
    .caps .mini{ margin:0; }
  </style>
</head>
<body>
<header>
  <h1>CSBM-TRPG キャラシ & ココフォリアチャパレ出力</h1>
  <div class="sub">入力→自動計算→チャパレ→JSON保存/読込 / ランダム（能力値合計15・各1〜5）</div>
</header>

<main>
  <!-- 基本情報 -->
  <section class="card">
    <h2>基本情報</h2>

    <div class="row2">
      <div>
        <label>キャラ名</label>
        <input id="name" />
      </div>
      <div>
        <label>概念 / 職業</label>
        <input id="role" />
      </div>
    </div>

    <div class="row3">
      <div>
        <label>年齢</label>
        <input id="age" type="number" min="0" step="1" />
      </div>
      <div>
        <label>性別</label>
        <select id="sex">
          <option value=""></option>
          <option value="男">男</option>
          <option value="女">女</option>
          <option value="その他">その他</option>
          <option value="不明">不明</option>
        </select>
      </div>
      <div>
        <label>身長（cm）</label>
        <input id="height" type="number" min="0" step="1" />
      </div>
    </div>

    <h2 style="margin-top:12px;">能力値 <span class="pill">1〜5</span></h2>
    <div class="row">
      <div><label>身体</label><input id="stat_body" type="number" min="1" max="5" value="3"></div>
      <div><label>知性</label><input id="stat_int"  type="number" min="1" max="5" value="3"></div>
      <div><label>社交</label><input id="stat_soc"  type="number" min="1" max="5" value="3"></div>
      <div><label>精神</label><input id="stat_spi"  type="number" min="1" max="5" value="3"></div>
      <div><label>運</label><input id="stat_luk"  type="number" min="1" max="5" value="3"></div>
    </div>

    <!-- ボタンは能力値の下 -->
    <div class="btns" style="margin-top:12px;">
      <button class="primary" id="btnRandom">ランダム（能力値+年齢/性別/身長）</button>
      <button id="btnRecalc">再計算</button>
    </div>

    <hr style="border:none;border-top:1px solid var(--line); margin:14px 0;">

    <div class="kpi">
      <div class="box">
        <div class="name">HP</div>
        <div class="v" id="kpi_hp">-</div>
        <div class="desc">HP = 身体 + 精神 + 5</div>
      </div>
      <div class="box">
        <div class="name">DB</div>
        <div class="v" id="kpi_db">-</div>
        <div class="desc">DB = 身体 - 3</div>
      </div>
      <div class="box">
        <div class="name">MV</div>
        <div class="v" id="kpi_mv">-</div>
        <div class="desc">MV = 身体 + 運</div>
      </div>
    </div>

    <p class="hint" style="margin-top:12px;">
      補正ダイス変換：<span class="mono">合計pt → 0:無し / 1-2:d2 / 3-4:d4 / 5+:d6</span>（最大d6）
    </p>
  </section>

  <!-- 特徴（固定3） -->
  <section class="card">
    <h2>特徴（信条×2 / 欠陥×1）</h2>
    <div class="hint">信条は対象ダイスに <b>+1d6</b>、欠陥は <b>-1d6</b>。詳細はタップで開閉。</div>
    <div class="list" id="traitList"></div>
  </section>

  <!-- 分野：得意 -->
  <section class="card">
    <h2>得意分野</h2>
    <div class="hint">得意は <b>+2pt</b>。ジャンル：知識 / 社交 / 支援 / 戦闘 / 行動。</div>

    <div class="row4">
      <div>
        <label>名称</label>
        <input id="good_name" />
      </div>
      <div>
        <label>ジャンル</label>
        <select id="good_cat">
          <option value="knowledge">知識</option>
          <option value="social">社交</option>
          <option value="support">支援</option>
          <option value="combat">戦闘</option>
          <option value="action">行動</option>
        </select>
      </div>
      <div>
        <label>pt</label>
        <input value="+2" disabled />
      </div>
      <div style="align-self:end;">
        <button class="primary" id="btnAddGood" style="width:100%;">追加</button>
      </div>
    </div>

    <div class="caps">
      <div class="mini" id="goodCapInfo"></div>
    </div>

    <div class="list" id="goodList"></div>
  </section>

  <!-- 分野：苦手 -->
  <section class="card">
    <h2>苦手分野</h2>
    <div class="hint">苦手は <b>-2pt</b>。</div>

    <div class="row4">
      <div>
        <label>名称</label>
        <input id="bad_name" />
      </div>
      <div>
        <label>ジャンル</label>
        <select id="bad_cat">
          <option value="knowledge">知識</option>
          <option value="social">社交</option>
          <option value="support">支援</option>
          <option value="combat">戦闘</option>
          <option value="action">行動</option>
        </select>
      </div>
      <div>
        <label>pt</label>
        <input value="-2" disabled />
      </div>
      <div style="align-self:end;">
        <button class="primary" id="btnAddBad" style="width:100%;">追加</button>
      </div>
    </div>

    <div class="caps">
      <div class="mini" id="badCapInfo"></div>
    </div>

    <div class="list" id="badList"></div>
  </section>

  <!-- 所持品 -->
  <section class="card">
    <h2>所持品 <span class="pill">最大3枠 / 合計+3</span></h2>
    <div class="hint">追加時に上限を超える場合は <b>弾く</b>。</div>

    <div class="row4">
      <div>
        <label>名称</label>
        <input id="item_name" />
      </div>
      <div>
        <label>ジャンル</label>
        <select id="item_cat">
          <option value="knowledge">知識</option>
          <option value="social">社交</option>
          <option value="support">支援</option>
          <option value="combat">戦闘</option>
          <option value="action">行動</option>
        </select>
      </div>
      <div>
        <label>補正pt</label>
        <select id="item_pt">
          <option value="0">0</option>
          <option value="1">+1</option>
          <option value="2">+2</option>
          <option value="3">+3</option>
        </select>
      </div>
      <div style="align-self:end;">
        <button class="primary" id="btnAddItem" style="width:100%;">追加</button>
      </div>
    </div>

    <div class="list" id="itemList"></div>
    <div class="mini" id="itemCapInfo" style="margin-top:8px;"></div>
  </section>

  <!-- 関係 -->
  <section class="card">
    <h2>関係</h2>

    <div class="row4">
      <div>
        <label>名前</label>
        <input id="rel_name" />
      </div>
      <div>
        <label>内容</label>
        <input id="rel_note" />
      </div>
      <div>
        <label>重要度</label>
        <select id="rel_val">
          <option value="-3">-3</option><option value="-2">-2</option><option value="-1">-1</option>
          <option value="0" selected>0</option>
          <option value="1">+1</option><option value="2">+2</option><option value="3">+3</option>
        </select>
      </div>
      <div style="align-self:end;">
        <button class="primary" id="btnAddRel" style="width:100%;">追加</button>
      </div>
    </div>

    <div class="list" id="relList"></div>
  </section>

  <!-- キャラメモ（別枠） -->
  <section class="card">
    <h2>キャラメモ</h2>
    <textarea id="memo" class="mono"></textarea>
  </section>

  <!-- チャパレ -->
  <section class="card full">
    <h2>チャパレ（ココフォリア用）</h2>
    <div class="row2">
      <div>
        <label>環境補正（固定値）</label>
        <input id="env_fixed" type="number" value="0" min="-3" max="3" />

        <label>関係補正を適用する対象名（任意）</label>
        <input id="rel_target" />

        <div class="btns">
          <button class="primary" id="btnMakePalette">チャパレ生成</button>
          <button id="btnCopy">コピー</button>
        </div>
      </div>

      <div>
        <label>出力</label>
        <textarea id="palette" class="mono" readonly></textarea>
      </div>
    </div>
  </section>

  <!-- JSON -->
  <section class="card full">
    <h2>JSON保存 / 読込</h2>
    <div class="row2">
      <div>
        <label>保存</label>
        <textarea id="json_out" class="mono" readonly></textarea>
        <div class="btns">
          <button id="btnSave">JSON生成</button>
        </div>
      </div>
      <div>
        <label>読込</label>
        <textarea id="json_in" class="mono"></textarea>
        <div class="btns">
          <button class="primary" id="btnLoad">JSON読込</button>
        </div>
      </div>
    </div>
  </section>
</main>

<script>
/** ---------- helpers ---------- **/
const $ = (id)=>document.getElementById(id);
const clamp = (n,min,max)=>Math.max(min, Math.min(max, n));
const sign = (n)=> n>0?"+":(n<0?"-":"");
const catLabel = (c)=>({ knowledge:"知識", social:"社交", support:"支援", combat:"戦闘", action:"行動" }[c] ?? c);

function ptsToDieSize(pt){
  const neg = pt < 0;
  const a = Math.abs(pt);
  if(a <= 0) return { die:null, neg:false };
  if(a <= 2) return { die:2, neg };
  if(a <= 4) return { die:4, neg };
  return { die:6, neg };
}
function fmtDie(dieObj){
  if(!dieObj.die) return "";
  return (dieObj.neg ? "-1d" : "+1d") + dieObj.die;
}
function sumBy(list, fn){ return list.reduce((acc,x)=>acc+fn(x),0); }
function escAttr(s){
  return String(s ?? "").replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
}

/** ---------- state ---------- **/
const state = {
  goods: [],  // {name, cat}
  bads: [],   // {name, cat}
  items: [],  // {name, cat, pt}
  rels: [],   // {name, note, val}
  traits: []  // {type, text, detail, target}
};

function ensureDefaultTraits(){
  if(!Array.isArray(state.traits)) state.traits = [];
  const beliefs = state.traits.filter(t=>t.type==="belief").slice(0,2);
  const flaws   = state.traits.filter(t=>t.type==="flaw").slice(0,1);

  while(beliefs.length < 2) beliefs.push({ type:"belief", text:"", detail:"", target:"action" });
  while(flaws.length < 1)   flaws.push({ type:"flaw",   text:"", detail:"", target:"action" });

  state.traits = [...beliefs, ...flaws].map(t=>({
    type: t.type,
    text: t.text ?? "",
    detail: t.detail ?? "",
    target: t.target ?? "action"
  }));
}

function traitTargetLabel(t){
  return ({
    research:"調査ダイス",
    social:"社交ダイス",
    support:"支援ダイス",
    attack:"攻撃ダイス",
    action:"行動ダイス",
    ability:"能力ダイス"
  }[t] ?? t);
}

/** ---------- rendering ---------- **/
function renderGoods(){
  $("goodCapInfo").textContent = `現在：${state.goods.length}`;
  const box = $("goodList");
  box.innerHTML = "";
  state.goods.forEach((s, idx)=>{
    const row = document.createElement("div");
    row.className = "item";
    row.innerHTML = `
      <div><span class="mono">${escAttr(s.name)}</span> <span class="pill">${catLabel(s.cat)}</span></div>
      <div class="mini">+2pt</div>
      <div class="mini"></div>
      <div class="del"><button class="danger" data-del-good="${idx}">削除</button></div>
    `;
    box.appendChild(row);
  });
  box.querySelectorAll("[data-del-good]").forEach(btn=>{
    btn.onclick = ()=>{ state.goods.splice(Number(btn.dataset.delGood),1); recalcAll(); };
  });
}

function renderBads(){
  $("badCapInfo").textContent = `現在：${state.bads.length}`;
  const box = $("badList");
  box.innerHTML = "";
  state.bads.forEach((s, idx)=>{
    const row = document.createElement("div");
    row.className = "item";
    row.innerHTML = `
      <div><span class="mono">${escAttr(s.name)}</span> <span class="pill">${catLabel(s.cat)}</span></div>
      <div class="mini">-2pt</div>
      <div class="mini"></div>
      <div class="del"><button class="danger" data-del-bad="${idx}">削除</button></div>
    `;
    box.appendChild(row);
  });
  box.querySelectorAll("[data-del-bad]").forEach(btn=>{
    btn.onclick = ()=>{ state.bads.splice(Number(btn.dataset.delBad),1); recalcAll(); };
  });
}

function renderItems(){
  const box = $("itemList");
  box.innerHTML = "";
  state.items.forEach((it, idx)=>{
    const row = document.createElement("div");
    row.className = "item";
    row.innerHTML = `
      <div><span class="mono">${escAttr(it.name)}</span> <span class="pill">${catLabel(it.cat)}</span></div>
      <div class="mini">pt ${Number(it.pt)>=0?("+"+it.pt):it.pt}</div>
      <div class="mini"></div>
      <div class="del"><button class="danger" data-del-item="${idx}">削除</button></div>
    `;
    box.appendChild(row);
  });
  box.querySelectorAll("[data-del-item]").forEach(btn=>{
    btn.onclick = ()=>{ state.items.splice(Number(btn.dataset.delItem),1); recalcAll(); };
  });

  const totalPt = sumBy(state.items, x=>Number(x.pt||0));
  const ok = totalPt <= 3 && state.items.length <= 3;
  $("itemCapInfo").textContent = `現在：枠 ${state.items.length}/3、補正pt合計 ${totalPt}/3 ${ok ? "" : "（上限超え）"}`;
}

function renderRels(){
  const box = $("relList");
  box.innerHTML = "";
  state.rels.forEach((r, idx)=>{
    const row = document.createElement("div");
    row.className = "item";
    row.innerHTML = `
      <div><span class="mono">${escAttr(r.name)}</span> <span class="pill">${escAttr(r.note||"")}</span></div>
      <div class="mini">${Number(r.val)>=0?("+"+r.val):r.val}</div>
      <div class="mini"></div>
      <div class="del"><button class="danger" data-del-rel="${idx}">削除</button></div>
    `;
    box.appendChild(row);
  });
  box.querySelectorAll("[data-del-rel]").forEach(btn=>{
    btn.onclick = ()=>{ state.rels.splice(Number(btn.dataset.delRel),1); recalcAll(); };
  });
}

function renderTraits(){
  ensureDefaultTraits();
  const box = $("traitList");
  box.innerHTML = "";

  state.traits.forEach((t, idx)=>{
    const wrap = document.createElement("div");
    wrap.style.display = "grid";
    wrap.style.gap = "8px";
    wrap.style.border = "1px solid var(--line)";
    wrap.style.borderRadius = "12px";
    wrap.style.padding = "10px";
    wrap.style.background = "#0f1219";

    wrap.innerHTML = `
      <div style="display:grid; gap:10px; grid-template-columns: 1fr 180px;">
        <div>
          <span class="pill">${t.type==="belief" ? "信条(+1d6)" : "欠陥(-1d6)"}</span>
          <input data-trait-text="${idx}" value="${escAttr(t.text)}" style="width:100%; margin-top:6px;" />
        </div>
        <div>
          <label style="margin-top:0;">対象</label>
          <select data-trait-target="${idx}" style="width:100%;">
            ${["research","social","support","attack","action","ability"].map(k=>`
              <option value="${k}" ${t.target===k?"selected":""}>${traitTargetLabel(k)}</option>
            `).join("")}
          </select>
        </div>
      </div>

      <details>
        <summary class="mini">詳細メモ（タップで開閉）</summary>
        <div style="margin-top:8px;">
          <textarea data-trait-detail="${idx}" class="mono" style="min-height:90px;">${t.detail ?? ""}</textarea>
        </div>
      </details>
    `;
    box.appendChild(wrap);
  });

  box.querySelectorAll("[data-trait-target]").forEach(sel=>{
    sel.onchange = ()=>{
      const idx = Number(sel.dataset.traitTarget);
      state.traits[idx].target = sel.value;
      recalcAll();
    };
  });
  box.querySelectorAll("[data-trait-text]").forEach(inp=>{
    inp.oninput = ()=>{
      const idx = Number(inp.dataset.traitText);
      state.traits[idx].text = inp.value;
      makePalette(); makeJsonOut();
    };
  });
  box.querySelectorAll("[data-trait-detail]").forEach(ta=>{
    ta.oninput = ()=>{
      const idx = Number(ta.dataset.traitDetail);
      state.traits[idx].detail = ta.value;
      makeJsonOut();
    };
  });
}

/** ---------- compute ---------- **/
function getStats(){
  const body = clamp(Number($("stat_body").value||3),1,5);
  const intel= clamp(Number($("stat_int").value||3),1,5);
  const soc  = clamp(Number($("stat_soc").value||3),1,5);
  const spi  = clamp(Number($("stat_spi").value||3),1,5);
  const luk  = clamp(Number($("stat_luk").value||3),1,5);
  return { body, intel, soc, spi, luk };
}

function computeDerived(stats){
  const hp = stats.body + stats.spi + 5;
  const db = stats.body - 3;
  const mv = stats.body + stats.luk;
  return { hp, db, mv };
}

function bonusPtsForCategory(cat){
  const goodPt = sumBy(state.goods.filter(s=>s.cat===cat), ()=> 2);
  const badPt  = sumBy(state.bads.filter(s=>s.cat===cat),  ()=> -2);
  const itemPt = sumBy(state.items.filter(i=>i.cat===cat),  i=> Number(i.pt||0));
  return goodPt + badPt + itemPt;
}

function traitDieFor(targetKey){
  let die = 0;
  state.traits.forEach(t=>{
    if(t.target !== targetKey) return;
    die += (t.type==="belief" ? 1 : -1);
  });
  if(die === 0) return "";
  const abs = Math.abs(die);
  const s = die>0 ? "+" : "-";
  return `${s}${abs}d6`;
}

function relFixedForTargetName(name){
  if(!name) return 0;
  const r = state.rels.find(x=>x.name === name);
  return r ? Number(r.val||0) : 0;
}

function makeDiceExpr(){
  const stats = getStats();
  const env = clamp(Number($("env_fixed").value||0), -3, 3);
  const relTarget = ($("rel_target").value||"").trim();
  const rel = relFixedForTargetName(relTarget);

  const ptsK = bonusPtsForCategory("knowledge");
  const ptsS = bonusPtsForCategory("social");
  const ptsSu= bonusPtsForCategory("support");
  const ptsC = bonusPtsForCategory("combat");
  const ptsA = bonusPtsForCategory("action");

  const dieK = fmtDie(ptsToDieSize(ptsK));
  const dieS = fmtDie(ptsToDieSize(ptsS));
  const dieSu= fmtDie(ptsToDieSize(ptsSu));
  const dieC = fmtDie(ptsToDieSize(ptsC));
  const dieA = fmtDie(ptsToDieSize(ptsA));

  const tResearch = traitDieFor("research");
  const tSocial   = traitDieFor("social");
  const tSupport  = traitDieFor("support");
  const tAttack   = traitDieFor("attack");
  const tAction   = traitDieFor("action");
  const tAbility  = traitDieFor("ability");

  const envStr = env ? `${sign(env)}${Math.abs(env)}` : "";

  const research = `2d6+1d${stats.intel}${dieK}${envStr}${tResearch}`;
  const socialEx = `2d6+1d${stats.soc}${dieS}${envStr}${tSocial}${rel?`${sign(rel)}${Math.abs(rel)}`:""}`;
  const support  = `2d6+1d${stats.intel}${dieSu}${envStr}${tSupport}${rel?`${sign(rel)}${Math.abs(rel)}`:""}`;
  const attack   = `2d6+1d${stats.body}${dieC}${envStr}${tAttack}`;
  const action   = `2d6+1d${computeDerived(stats).mv}${dieA}${envStr}${tAction}`;
  const ability  = `2d6+1d${stats.intel}+${stats.intel}${envStr}${tAbility}`;

  return { research, socialEx, support, attack, action, ability, env, relTarget, rel };
}

function recalcAll(){
  renderTraits();
  renderGoods();
  renderBads();
  renderItems();
  renderRels();

  const stats = getStats();
  const d = computeDerived(stats);
  $("kpi_hp").textContent = d.hp;
  $("kpi_db").textContent = (d.db>=0?("+"+d.db):String(d.db));
  $("kpi_mv").textContent = d.mv;

  makePalette();
  makeJsonOut();
}

function makePalette(){
  const d = computeDerived(getStats());
  const ex = makeDiceExpr();

  const nm = ($("name").value||"").trim();
  const role = ($("role").value||"").trim();
  const age = $("age").value ? String($("age").value) : "";
  const sex = ($("sex").value||"").trim();
  const h   = $("height").value ? String($("height").value) : "";

  const lines = [];
  lines.push(`// CSBM-TRPG チャパレ${nm ? "：" + nm : ""}`);
  if(role || age || sex || h){
    lines.push(`// ${role}${role && (age||sex||h) ? " / " : ""}${age?age+"歳":""}${sex?(" "+sex):""}${h?(" "+h+"cm"):""}`.trim());
  }
  lines.push(`// HP:${d.hp} DB:${d.db>=0?"+":""}${d.db} MV:${d.mv}`);
  if(ex.relTarget){
    lines.push(`// 関係補正対象：${ex.relTarget} (${ex.rel>=0?"+":""}${ex.rel})`);
  }
  if(ex.env){
    lines.push(`// 環境補正：${ex.env>=0?"+":""}${ex.env}`);
  }

  lines.push(`調査 ${ex.research}`);
  lines.push(`社交 ${ex.socialEx}`);
  lines.push(`支援 ${ex.support}`);
  lines.push(`攻撃 ${ex.attack}`);
  lines.push(`行動 ${ex.action}`);
  lines.push(`能力 ${ex.ability}`);

  lines.push(`// 戦闘`);
  lines.push(`命中 ${ex.attack}>=9`);
  lines.push(`回避 ${ex.action}  // 対抗：相手の攻撃値`);
  lines.push(`庇う ${ex.action}>=9`);
  lines.push(`回復 ${ex.support}>=9`);
  lines.push(`ダメ 1d3${d.db? (d.db>0?`+${d.db}`:`${d.db}`):""}`);

  $("palette").value = lines.join("\n");
}

function makeJsonOut(){
  const data = {
    name: $("name").value||"",
    role: $("role").value||"",
    age: $("age").value ? Number($("age").value) : null,
    sex: $("sex").value||"",
    height: $("height").value ? Number($("height").value) : null,
    memo: $("memo").value||"",
    stats: getStats(),
    env_fixed: Number($("env_fixed").value||0),
    goods: state.goods,
    bads: state.bads,
    items: state.items,
    rels: state.rels,
    traits: state.traits
  };
  $("json_out").value = JSON.stringify(data, null, 2);
}

/** ---------- random ---------- **/
function randomStatsSum15(){
  for(let tries=0; tries<20000; tries++){
    const arr = Array.from({length:5}, ()=> 1 + Math.floor(Math.random()*5));
    const sum = arr.reduce((a,b)=>a+b,0);
    if(sum === 15) return arr;
  }
  return [3,3,3,3,3];
}

function randInt(min, maxInclusive){
  return min + Math.floor(Math.random() * (maxInclusive - min + 1));
}

function randomProfile(){
  // ざっくり実用レンジ（必要なら後で設定可能にする）
  const age = randInt(16, 60);
  const height = randInt(140, 200);
  const sexes = ["男","女","その他"];
  const sex = sexes[randInt(0, sexes.length-1)];
  return { age, height, sex };
}

/** ---------- add rules (hard block) ---------- **/
function tryAddItem({name, cat, pt}){
  const n = (name||"").trim();
  if(!n) return false;

  const currentCount = state.items.length;
  if(currentCount >= 3){
    alert("所持品は最大3枠");
    return false;
  }

  const currentTotal = sumBy(state.items, x=>Number(x.pt||0));
  const nextTotal = currentTotal + Number(pt||0);
  if(nextTotal > 3){
    alert("所持品pt合計は最大+3");
    return false;
  }

  state.items.push({ name:n, cat, pt:Number(pt||0) });
  return true;
}

function tryAddGood({name, cat}){
  const n = (name||"").trim();
  if(!n) return false;

  state.goods.push({ name:n, cat });
  return true;
}

function tryAddBad({name, cat}){
  const n = (name||"").trim();
  if(!n) return false;

  state.bads.push({ name:n, cat });
  return true;
}

/** ---------- events ---------- **/
$("btnAddGood").onclick = ()=>{
  const ok = tryAddGood({ name:$("good_name").value, cat:$("good_cat").value });
  if(ok){ $("good_name").value=""; recalcAll(); }
};

$("btnAddBad").onclick = ()=>{
  const ok = tryAddBad({ name:$("bad_name").value, cat:$("bad_cat").value });
  if(ok){ $("bad_name").value=""; recalcAll(); }
};

$("btnAddItem").onclick = ()=>{
  const ok = tryAddItem({ name:$("item_name").value, cat:$("item_cat").value, pt:Number($("item_pt").value||0) });
  if(ok){ $("item_name").value=""; recalcAll(); }
};

$("btnAddRel").onclick = ()=>{
  const name = ($("rel_name").value||"").trim();
  if(!name) return;
  state.rels.push({ name, note:($("rel_note").value||"").trim(), val:Number($("rel_val").value||0) });
  $("rel_name").value = ""; $("rel_note").value = ""; $("rel_val").value = "0";
  recalcAll();
};

$("btnMakePalette").onclick = makePalette;

$("btnCopy").onclick = async ()=>{
  try{
    await navigator.clipboard.writeText($("palette").value);
    alert("コピーした");
  }catch(e){
    alert("コピー失敗。手動でコピーしてくれ。");
  }
};

$("btnRecalc").onclick = recalcAll;

$("btnRandom").onclick = ()=>{
  const [b,i,s,sp,l] = randomStatsSum15();
  $("stat_body").value = b;
  $("stat_int").value  = i;
  $("stat_soc").value  = s;
  $("stat_spi").value  = sp;
  $("stat_luk").value  = l;

  const p = randomProfile();
  $("age").value = p.age;
  $("sex").value = p.sex;
  $("height").value = p.height;

  recalcAll();
};

["stat_body","stat_int","stat_soc","stat_spi","stat_luk","env_fixed","rel_target","name","role","age","sex","height","memo"]
  .forEach(id=> $(id).addEventListener("input", recalcAll));

$("btnSave").onclick = makeJsonOut;

$("btnLoad").onclick = ()=>{
  try{
    const data = JSON.parse(($("json_in").value||"").trim());

    $("name").value = data.name ?? "";
    $("role").value = data.role ?? "";
    $("age").value = (data.age ?? "") === null ? "" : (data.age ?? "");
    $("sex").value = data.sex ?? "";
    $("height").value = (data.height ?? "") === null ? "" : (data.height ?? "");
    $("memo").value = data.memo ?? "";

    const st = data.stats ?? {};
    $("stat_body").value = st.body ?? 3;
    $("stat_int").value  = st.intel ?? 3;
    $("stat_soc").value  = st.soc ?? 3;
    $("stat_spi").value  = st.spi ?? 3;
    $("stat_luk").value  = st.luk ?? 3;

    $("env_fixed").value = data.env_fixed ?? 0;

    state.goods = Array.isArray(data.goods) ? data.goods : [];
    state.bads  = Array.isArray(data.bads)  ? data.bads  : [];
    state.items = Array.isArray(data.items) ? data.items : [];
    state.rels  = Array.isArray(data.rels)  ? data.rels  : [];
    state.traits= Array.isArray(data.traits)? data.traits: [];

    ensureDefaultTraits();
    recalcAll();
  }catch(e){
    alert("JSON読込失敗：形式がおかしい");
  }
};

// init
ensureDefaultTraits();
recalcAll();
</script>
</body>
</html>
