<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CSBM-TRPG キャラシ&チャパレ出力</title>
  <style>
    :root { --bg:#0f1115; --panel:#171a21; --text:#e7e9ee; --muted:#a9b0bf; --line:#2a3040; --acc:#7aa2ff; }
    body{ margin:0; background:var(--bg); color:var(--text); font-family:system-ui, -apple-system, "Segoe UI", sans-serif; }
    header{ padding:16px 18px; border-bottom:1px solid var(--line); position:sticky; top:0; background:rgba(15,17,21,.92); backdrop-filter: blur(8px); }
    h1{ font-size:16px; margin:0 0 6px; }
    .sub{ color:var(--muted); font-size:12px; }
    main{ padding:16px 18px; max-width:1100px; margin:0 auto; display:grid; gap:14px; grid-template-columns: 1fr 1fr; }
    .card{ background:var(--panel); border:1px solid var(--line); border-radius:12px; padding:14px; }
    .card h2{ font-size:14px; margin:0 0 10px; }
    label{ display:block; font-size:12px; color:var(--muted); margin:8px 0 4px; }
    input, select, textarea, button{
      font:inherit; color:var(--text);
      background:#0f1219; border:1px solid var(--line);
      border-radius:10px; padding:9px 10px;
      outline:none;
    }
    textarea{ width:100%; min-height:140px; resize:vertical; }
    input[type="number"]{ width:100%; }
    .row{ display:grid; gap:10px; grid-template-columns: repeat(5, 1fr); }
    .row2{ display:grid; gap:10px; grid-template-columns: 1fr 1fr; }
    .row3{ display:grid; gap:10px; grid-template-columns: 2fr 1fr 1fr; }
    .row4{ display:grid; gap:10px; grid-template-columns: 2fr 1fr 1fr 1fr; }
    .btns{ display:flex; flex-wrap:wrap; gap:8px; margin-top:10px; }
    button{ cursor:pointer; }
    button.primary{ border-color:rgba(122,162,255,.45); background:rgba(122,162,255,.12); }
    button.danger{ border-color:rgba(255,90,90,.35); background:rgba(255,90,90,.10); }
    .mini{ font-size:12px; color:var(--muted); }
    .list{ display:grid; gap:8px; margin-top:10px; }
    .item{ display:grid; gap:8px; grid-template-columns: 1.6fr 1fr 1fr .8fr; align-items:center; }
    .item .del{ justify-self:end; }
    .kpi{ display:grid; gap:8px; grid-template-columns: repeat(4, 1fr); }
    .kpi div{ background:#0f1219; border:1px solid var(--line); border-radius:10px; padding:10px; }
    .kpi .v{ font-size:18px; font-weight:700; }
    .kpi .k{ font-size:11px; color:var(--muted); }
    .full{ grid-column: 1 / -1; }
    @media (max-width: 960px){
      main{ grid-template-columns: 1fr; }
      .row{ grid-template-columns: repeat(2,1fr); }
      .kpi{ grid-template-columns: repeat(2,1fr); }
    }
    .pill{ display:inline-block; padding:3px 8px; border-radius:999px; border:1px solid var(--line); color:var(--muted); font-size:11px; margin-left:6px; }
    .hint{ color:var(--muted); font-size:12px; line-height:1.5; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
  </style>
</head>
<body>
<header>
  <h1>CSBM-TRPG キャラシ & ココフォリアチャパレ出力</h1>
  <div class="sub">MVP：入力→自動計算→チャパレ→JSON保存/読込 / 能力値ランダム（合計15・各1〜5）</div>
</header>

<main>
  <section class="card">
    <h2>基本情報</h2>
    <div class="row2">
      <div>
        <label>キャラ名</label>
        <input id="name" placeholder="例：霧島レン" />
      </div>
      <div>
        <label>概念 / 職業</label>
        <input id="role" placeholder="例：調査員 / 学生 / 傭兵" />
      </div>
    </div>

    <h2 style="margin-top:0;">能力値 <span class="pill">1〜5</span></h2>
    <div class="row">
      <div><label>身体</label><input id="stat_body" type="number" min="1" max="5" value="3"></div>
      <div><label>知性</label><input id="stat_int"  type="number" min="1" max="5" value="3"></div>
      <div><label>社交</label><input id="stat_soc"  type="number" min="1" max="5" value="3"></div>
      <div><label>精神</label><input id="stat_spi"  type="number" min="1" max="5" value="3"></div>
      <div><label>運</label><input id="stat_luk"  type="number" min="1" max="5" value="3"></div>
    </div>

    <div class="btns" style="margin-top:12px;">
      <button class="primary" id="btnRandom">能力値ランダム</button>
      <button id="btnRecalc">再計算</button>
    </div>

    <hr style="border:none;border-top:1px solid var(--line); margin:14px 0;">
    
    <div class="kpi" style="margin-top:12px;">
      <div><div class="v" id="kpi_hp">-</div><div class="k">HP = 身体 + 精神 + 5</div></div>
      <div><div class="v" id="kpi_db">-</div><div class="k">DB = 身体 - 3</div></div>
      <div><div class="v" id="kpi_mv">-</div><div class="k">MV = 身体 + 運</div></div>
      <div><div class="v" id="kpi_mp">-</div><div class="k">MP = 知性 + 精神 + 5（拡張）</div></div>
    </div>

    <p class="hint" style="margin-top:12px;">
      補正ダイス変換：<span class="mono">合計ポイント → 0:無し / 1-2:d2 / 3-4:d4 / 5+:d6</span>（最大d6）<br>
      ※この変換は後で好きに調整できる。今はMVPの“動く形”を優先。
    </p>
  </section>

  <section class="card">
    <h2>特徴（信条×2 / 欠陥×1）</h2>
    <div class="hint">信条は対象ダイスに <b>+1d6</b>、欠陥は <b>-1d6</b>（場面により適用）。</div>

    <div class="list" id="traitList"></div>

  <section class="card">
    <h2>分野（得意/苦手）</h2>
    <div class="hint">各3つ想定。ジャンル：知識 / 社交 / 支援 / 戦闘 / 行動。得意:+2pt / 苦手:-2pt を合算して補正ダイス化。</div>

    <div class="row4">
      <div>
        <label>名称</label>
        <input id="skill_name" placeholder="例：潜入 / 化学 / 交渉" />
      </div>
      <div>
        <label>ジャンル</label>
        <select id="skill_cat">
          <option value="knowledge">知識</option>
          <option value="social">社交</option>
          <option value="support">支援</option>
          <option value="combat">戦闘</option>
          <option value="action">行動</option>
        </select>
      </div>
      <div>
        <label>種別</label>
        <select id="skill_kind">
          <option value="good">得意 (+2pt)</option>
          <option value="bad">苦手 (-2pt)</option>
        </select>
      </div>
      <div style="align-self:end;">
        <button class="primary" id="btnAddSkill" style="width:100%;">追加</button>
      </div>
    </div>

    <div class="list" id="skillList"></div>
  </section>

  <section class="card">
    <h2>所持品（最大3枠 / 合計+3）</h2>
    <div class="hint">所持品はジャンルに紐づけてpt加算（例：辞典+1→知識、拳銃+2→戦闘）。</div>

    <div class="row4">
      <div>
        <label>名称</label>
        <input id="item_name" placeholder="例：救急箱 / 辞典 / 拳銃" />
      </div>
      <div>
        <label>ジャンル</label>
        <select id="item_cat">
          <option value="knowledge">知識</option>
          <option value="social">社交</option>
          <option value="support">支援</option>
          <option value="combat">戦闘</option>
          <option value="action">行動</option>
        </select>
      </div>
      <div>
        <label>補正pt</label>
        <select id="item_pt">
          <option value="0">0</option>
          <option value="1">+1</option>
          <option value="2">+2</option>
          <option value="3">+3</option>
        </select>
      </div>
      <div style="align-self:end;">
        <button class="primary" id="btnAddItem" style="width:100%;">追加</button>
      </div>
    </div>

    <div class="list" id="itemList"></div>
    <div class="mini" id="itemCapInfo" style="margin-top:8px;"></div>
  </section>

  <section class="card">
    <h2>関係</h2>
    <div class="hint">対象が関係リストにいる時のみ適用（社交/支援などに +数値）。</div>

    <div class="row4">
      <div>
        <label>名前</label>
        <input id="rel_name" placeholder="例：相棒 / 母 / 上司" />
      </div>
      <div>
        <label>内容</label>
        <input id="rel_note" placeholder="例：信頼 / 嫌い / 借り" />
      </div>
      <div>
        <label>重要度</label>
        <select id="rel_val">
          <option value="-3">-3</option><option value="-2">-2</option><option value="-1">-1</option>
          <option value="0" selected>0</option>
          <option value="1">+1</option><option value="2">+2</option><option value="3">+3</option>
        </select>
      </div>
      <div style="align-self:end;">
        <button class="primary" id="btnAddRel" style="width:100%;">追加</button>
      </div>
    </div>

    <div class="list" id="relList"></div>
  </section>

  <section class="card full">
    <h2>チャパレ（ココフォリア用）</h2>
    <div class="row2">
      <div>
        <label>環境補正（固定値）</label>
        <input id="env_fixed" type="number" value="0" min="-3" max="3" />
        <div class="mini">例：暗闇 -1 / 応援 +1</div>

        <label>関係補正を適用する対象名（任意）</label>
        <input id="rel_target" placeholder="例：相棒（この名前が関係にあれば加算）" />
        <div class="mini">空なら関係補正はチャパレには付けず、GM判断で足す運用。</div>

        <div class="btns">
          <button class="primary" id="btnMakePalette">チャパレ生成</button>
          <button id="btnCopy">コピー</button>
        </div>
      </div>

      <div>
        <label>出力</label>
        <textarea id="palette" class="mono" readonly></textarea>
      </div>
    </div>
  </section>

  <section class="card full">
    <h2>JSON保存 / 読込</h2>
    <div class="row2">
      <div>
        <label>保存（ここをコピーして保存）</label>
        <textarea id="json_out" class="mono" readonly></textarea>
        <div class="btns">
          <button id="btnSave">JSON生成</button>
        </div>
      </div>
      <div>
        <label>読込（ここに貼って読込）</label>
        <textarea id="json_in" class="mono" placeholder='{"name":"..."}'></textarea>
        <div class="btns">
          <button class="primary" id="btnLoad">JSON読込</button>
        </div>
      </div>
    </div>
  </section>
</main>

<script>
/** ---------- helpers ---------- **/
const $ = (id)=>document.getElementById(id);
const clamp = (n,min,max)=>Math.max(min, Math.min(max, n));
const sign = (n)=> n>0?"+":(n<0?"-":"");
const catLabel = (c)=>({
  knowledge:"知識", social:"社交", support:"支援", combat:"戦闘", action:"行動"
}[c] ?? c);

function ptsToDieSize(pt){
  // pt can be negative; we return {die: number|null, neg:boolean}
  const neg = pt < 0;
  const a = Math.abs(pt);
  if(a <= 0) return { die:null, neg:false };
  if(a <= 2) return { die:2, neg };
  if(a <= 4) return { die:4, neg };
  return { die:6, neg }; // cap at d6
}

function fmtDie(dieObj){
  if(!dieObj.die) return "";
  return (dieObj.neg ? "-1d" : "+1d") + dieObj.die;
}

function sumBy(list, fn){ return list.reduce((acc,x)=>acc+fn(x),0); }

/** ---------- state ---------- **/
const state = {
  skills: [], // {name, cat, kind} kind:good|bad
  items: [],  // {name, cat, pt}
  rels: [],   // {name, note, val}
  traits: []  // {type:belief|flaw, text, target} target: research/social/support/attack/action/ability
};

function ensureDefaultTraits(){
  // 固定3つ：信条2 + 欠陥1
  if(!Array.isArray(state.traits)) state.traits = [];

  // 既存を信条/欠陥で分けて再構成（余計な分は捨てる）
  const beliefs = state.traits.filter(t=>t.type==="belief").slice(0,2);
  const flaws   = state.traits.filter(t=>t.type==="flaw").slice(0,1);

  while(beliefs.length < 2){
    beliefs.push({ type:"belief", text:"（信条）", target:"action" });
  }
  while(flaws.length < 1){
    flaws.push({ type:"flaw", text:"（欠陥）", target:"action" });
  }

  state.traits = [...beliefs, ...flaws];
}

function traitTargetLabel(t){
  return ({
    research:"調査ダイス",
    social:"社交ダイス",
    support:"支援ダイス",
    attack:"攻撃ダイス",
    action:"行動ダイス",
    ability:"能力ダイス"
  }[t] ?? t);
}

/** ---------- rendering ---------- **/
function renderSkills(){
  const box = $("skillList");
  box.innerHTML = "";
  state.skills.forEach((s, idx)=>{
    const row = document.createElement("div");
    row.className = "item";
    row.innerHTML = `
      <div><span class="mono">${escapeHtml(s.name)}</span> <span class="pill">${catLabel(s.cat)}</span></div>
      <div class="mini">${s.kind==="good" ? "得意(+2pt)" : "苦手(-2pt)"}</div>
      <div class="mini"></div>
      <div class="del"><button class="danger" data-del-skill="${idx}">削除</button></div>
    `;
    box.appendChild(row);
  });
  box.querySelectorAll("[data-del-skill]").forEach(btn=>{
    btn.onclick = ()=>{ state.skills.splice(Number(btn.dataset.delSkill),1); recalcAll(); };
  });
}

function renderItems(){
  const box = $("itemList");
  box.innerHTML = "";
  state.items.forEach((it, idx)=>{
    const row = document.createElement("div");
    row.className = "item";
    row.innerHTML = `
      <div><span class="mono">${escapeHtml(it.name)}</span> <span class="pill">${catLabel(it.cat)}</span></div>
      <div class="mini">pt ${it.pt>=0?("+"+it.pt):it.pt}</div>
      <div class="mini"></div>
      <div class="del"><button class="danger" data-del-item="${idx}">削除</button></div>
    `;
    box.appendChild(row);
  });
  box.querySelectorAll("[data-del-item]").forEach(btn=>{
    btn.onclick = ()=>{ state.items.splice(Number(btn.dataset.delItem),1); recalcAll(); };
  });

  const totalPt = sumBy(state.items, x=>x.pt);
  const cap = totalPt <= 3 && state.items.length <= 3;
  $("itemCapInfo").textContent = `現在：枠 ${state.items.length}/3、補正pt合計 ${totalPt}/3 ${cap ? "" : "（上限超え）"}`;
}

function renderRels(){
  const box = $("relList");
  box.innerHTML = "";
  state.rels.forEach((r, idx)=>{
    const row = document.createElement("div");
    row.className = "item";
    row.innerHTML = `
      <div><span class="mono">${escapeHtml(r.name)}</span> <span class="pill">${escapeHtml(r.note||"関係")}</span></div>
      <div class="mini">${r.val>=0?("+"+r.val):r.val}</div>
      <div class="mini"></div>
      <div class="del"><button class="danger" data-del-rel="${idx}">削除</button></div>
    `;
    box.appendChild(row);
  });
  box.querySelectorAll("[data-del-rel]").forEach(btn=>{
    btn.onclick = ()=>{ state.rels.splice(Number(btn.dataset.delRel),1); recalcAll(); };
  });
}

function renderTraits(){
  ensureDefaultTraits();
  const box = $("traitList");
  box.innerHTML = "";

  state.traits.forEach((t, idx)=>{
    const row = document.createElement("div");
    row.className = "item";

    row.innerHTML = `
      <div>
        <span class="pill">${t.type==="belief" ? "信条(+1d6)" : "欠陥(-1d6)"}</span>
        <input
          data-trait-text="${idx}"
          value="${escapeHtml(t.text)}"
          placeholder="${t.type==="belief" ? "信条を書く" : "欠陥を書く"}"
          style="width:100%; margin-top:6px;"
        />
      </div>

      <div>
        <select data-trait-target="${idx}">
          ${["research","social","support","attack","action","ability"].map(k=>`
            <option value="${k}" ${t.target===k?"selected":""}>${traitTargetLabel(k)}</option>
          `).join("")}
        </select>
      </div>

      <div class="mini"></div>
      <div class="del"></div>
    `;

    box.appendChild(row);
  });

  box.querySelectorAll("[data-trait-target]").forEach(sel=>{
    sel.onchange = ()=>{
      const idx = Number(sel.dataset.traitTarget);
      state.traits[idx].target = sel.value;
      recalcAll();
    };
  });

  box.querySelectorAll("[data-trait-text]").forEach(inp=>{
    inp.oninput = ()=>{
      const idx = Number(inp.dataset.traitText);
      state.traits[idx].text = inp.value;
      // 文字変えただけなら再計算いらないけど、JSON/表示更新したいので recalc
      recalcAll();
    };
  });
}

  box.querySelectorAll("[data-del-trait]").forEach(btn=>{
    btn.onclick = ()=>{
      state.traits.splice(Number(btn.dataset.delTrait),1);
      recalcAll();
    };
  });
}

function escapeHtml(s){
  return String(s ?? "").replace(/[&<>"']/g, (m)=>({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
  }[m]));
}

/** ---------- compute ---------- **/
function getStats(){
  const body = clamp(Number($("stat_body").value||3),1,5);
  const intel= clamp(Number($("stat_int").value||3),1,5);
  const soc  = clamp(Number($("stat_soc").value||3),1,5);
  const spi  = clamp(Number($("stat_spi").value||3),1,5);
  const luk  = clamp(Number($("stat_luk").value||3),1,5);
  return { body, intel, soc, spi, luk };
}

function computeDerived(stats){
  const hp = stats.body + stats.spi + 5;
  const db = stats.body - 3;
  const mv = stats.body + stats.luk;
  const mp = stats.intel + stats.spi + 5;
  return { hp, db, mv, mp };
}

function bonusPtsForCategory(cat){
  // skills: good +2, bad -2; items: add pt
  const spt = sumBy(state.skills.filter(s=>s.cat===cat), s=> s.kind==="good" ? 2 : -2);
  const ipt = sumBy(state.items.filter(i=>i.cat===cat), i=> Number(i.pt||0));
  return spt + ipt;
}

function traitDieFor(targetKey){
  // beliefs +1d6, flaws -1d6 for matching target
  let die = 0;
  state.traits.forEach(t=>{
    if(t.target !== targetKey) return;
    die += (t.type==="belief" ? 1 : -1);
  });
  // die is count of d6 dice with sign; we only support -1d6..+2d6 etc.
  if(die === 0) return "";
  const abs = Math.abs(die);
  const s = die>0 ? "+" : "-";
  return `${s}${abs}d6`;
}

function relFixedForTargetName(name){
  if(!name) return 0;
  const r = state.rels.find(x=>x.name === name);
  return r ? Number(r.val||0) : 0;
}

function makeDiceExpr(){
  const stats = getStats();
  const env = clamp(Number($("env_fixed").value||0), -3, 3);
  const relTarget = ($("rel_target").value||"").trim();
  const rel = relFixedForTargetName(relTarget);

  const ptsKnowledge = bonusPtsForCategory("knowledge");
  const ptsSocial    = bonusPtsForCategory("social");
  const ptsSupport   = bonusPtsForCategory("support");
  const ptsCombat    = bonusPtsForCategory("combat");
  const ptsAction    = bonusPtsForCategory("action");

  const dieK = fmtDie(ptsToDieSize(ptsKnowledge));
  const dieS = fmtDie(ptsToDieSize(ptsSocial));
  const dieSu= fmtDie(ptsToDieSize(ptsSupport));
  const dieC = fmtDie(ptsToDieSize(ptsCombat));
  const dieA = fmtDie(ptsToDieSize(ptsAction));

  // trait dice by target
  const tResearch = traitDieFor("research");
  const tSocial   = traitDieFor("social");
  const tSupport  = traitDieFor("support");
  const tAttack   = traitDieFor("attack");
  const tAction   = traitDieFor("action");
  const tAbility  = traitDieFor("ability");

  // expressions (you can tweak to match your final formula)
  const research = `2d6+1d${stats.intel}${dieK}${env?`${sign(env)}${Math.abs(env)}`:""}${tResearch}`;
  const socialEx = `2d6+1d${stats.soc}${dieS}${env?`${sign(env)}${Math.abs(env)}`:""}${tSocial}${rel?`${sign(rel)}${Math.abs(rel)}`:""}`;
  const support  = `2d6+1d${stats.intel}${dieSu}${env?`${sign(env)}${Math.abs(env)}`:""}${tSupport}${rel?`${sign(rel)}${Math.abs(rel)}`:""}`;
  const attack   = `2d6+1d${stats.body}${dieC}${env?`${sign(env)}${Math.abs(env)}`:""}${tAttack}`; // 関係補正は通常入れない運用
  const action   = `2d6+1d${computeDerived(stats).mv}${dieA}${env?`${sign(env)}${Math.abs(env)}`:""}${tAction}`;
  // ability dice: safer form
  const ability  = `2d6+1d${stats.intel}+${stats.intel}${env?`${sign(env)}${Math.abs(env)}`:""}${tAbility}`; // デフォは知性参照、必要なら切替

  return { research, socialEx, support, attack, action, ability, env, relTarget, rel };
}

function recalcAll(){
  renderSkills(); renderItems(); renderRels(); renderTraits();

  const stats = getStats();
  const d = computeDerived(stats);
  $("kpi_hp").textContent = d.hp;
  $("kpi_db").textContent = (d.db>=0?("+"+d.db):String(d.db));
  $("kpi_mv").textContent = d.mv;
  $("kpi_mp").textContent = d.mp;

  // auto refresh palette + json
  makePalette();
  makeJsonOut();
}

function makePalette(){
  const stats = getStats();
  const d = computeDerived(stats);
  const ex = makeDiceExpr();

  const lines = [];
  const nm = ($("name").value||"PC").trim() || "PC";
  lines.push(`// CSBM-TRPG チャパレ：${nm}`);
  lines.push(`// HP:${d.hp} DB:${d.db>=0?"+":""}${d.db} MV:${d.mv} MP:${d.mp}`);
  if(ex.relTarget){
    lines.push(`// 関係補正対象：${ex.relTarget} (${ex.rel>=0?"+":""}${ex.rel})`);
  }
  if(ex.env){
    lines.push(`// 環境補正：${ex.env>=0?"+":""}${ex.env}`);
  }

  lines.push(`調査 ${ex.research}`);
  lines.push(`社交 ${ex.socialEx}`);
  lines.push(`支援 ${ex.support}`);
  lines.push(`攻撃 ${ex.attack}`);
  lines.push(`行動 ${ex.action}`);
  lines.push(`能力 ${ex.ability}`);

  lines.push(`// 戦闘`);
  lines.push(`命中 ${ex.attack}>=9`);
  lines.push(`回避 ${ex.action}>=9`);
  lines.push(`庇う ${ex.action}>=9`);
  lines.push(`回復 ${ex.support}>=9`);
  lines.push(`ダメ 1d3${d.db? (d.db>0?`+${d.db}`:`${d.db}`):""}`);

  $("palette").value = lines.join("\n");
}

function makeJsonOut(){
  const stats = getStats();
  const data = {
    name: $("name").value||"",
    role: $("role").value||"",
    tagline: $("tagline").value||"",
    stats,
    env_fixed: Number($("env_fixed").value||0),
    skills: state.skills,
    items: state.items,
    rels: state.rels,
    traits: state.traits
  };
  $("json_out").value = JSON.stringify(data, null, 2);
}

function makePaletteButton(){
  makePalette();
}

function randomStatsSum15(){
  // generate 5 stats 1..5 sum 15
  // brute force loop
  for(let tries=0; tries<20000; tries++){
    const arr = Array.from({length:5}, ()=> 1 + Math.floor(Math.random()*5));
    const sum = arr.reduce((a,b)=>a+b,0);
    if(sum === 15) return arr;
  }
  // fallback deterministic
  return [3,3,3,3,3];
}

/** ---------- events ---------- **/
$("btnAddSkill").onclick = ()=>{
  const name = ($("skill_name").value||"").trim();
  if(!name) return;
  state.skills.push({ name, cat:$("skill_cat").value, kind:$("skill_kind").value });
  $("skill_name").value = "";
  recalcAll();
};

$("btnAddItem").onclick = ()=>{
  const name = ($("item_name").value||"").trim();
  if(!name) return;
  const pt = Number($("item_pt").value||0);
  // enforce caps softly (allow but warn via text)
  state.items.push({ name, cat:$("item_cat").value, pt });
  $("item_name").value = "";
  recalcAll();
};

$("btnAddRel").onclick = ()=>{
  const name = ($("rel_name").value||"").trim();
  if(!name) return;
  state.rels.push({ name, note:($("rel_note").value||"").trim(), val:Number($("rel_val").value||0) });
  $("rel_name").value = ""; $("rel_note").value = ""; $("rel_val").value = "0";
  recalcAll();
};

$("btnMakePalette").onclick = makePaletteButton;

$("btnCopy").onclick = async ()=>{
  try{
    await navigator.clipboard.writeText($("palette").value);
    alert("コピーした");
  }catch(e){
    alert("コピー失敗。手動でコピーしてくれ。");
  }
};

$("btnRecalc").onclick = recalcAll;

$("btnRandom").onclick = ()=>{
  const [b,i,s,sp,l] = randomStatsSum15();
  $("stat_body").value = b;
  $("stat_int").value  = i;
  $("stat_soc").value  = s;
  $("stat_spi").value  = sp;
  $("stat_luk").value  = l;
  recalcAll();
};

["stat_body","stat_int","stat_soc","stat_spi","stat_luk","env_fixed","rel_target","name","role","tagline"]
  .forEach(id=> $(id).addEventListener("input", recalcAll));

$("btnSave").onclick = makeJsonOut;

$("btnLoad").onclick = ()=>{
  try{
    const txt = $("json_in").value.trim();
    const data = JSON.parse(txt);
    $("name").value = data.name ?? "";
    $("role").value = data.role ?? "";
    $("tagline").value = data.tagline ?? "";
    const st = data.stats ?? {};
    $("stat_body").value = st.body ?? 3;
    $("stat_int").value  = st.intel ?? 3;
    $("stat_soc").value  = st.soc ?? 3;
    $("stat_spi").value  = st.spi ?? 3;
    $("stat_luk").value  = st.luk ?? 3;
    $("env_fixed").value = data.env_fixed ?? 0;

    state.skills = Array.isArray(data.skills) ? data.skills : [];
    state.items  = Array.isArray(data.items) ? data.items : [];
    state.rels   = Array.isArray(data.rels) ? data.rels : [];
    state.traits = Array.isArray(data.traits) ? data.traits : [];
    ensureDefaultTraits();
    recalcAll();
  }catch(e){
    alert("JSON読込失敗：形式がおかしい");
  }
};

// init
ensureDefaultTraits();
recalcAll();
</script>
</body>
</html>
