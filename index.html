<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CSBM-TRPG キャラシ作成ツール</title>
  <style>
/* ===== 修正版：丸み＆カラー統一パッチ ===== */
:root {
  /* Colors */
  --bg: #4A5C52;           /* 全体背景 */
  --panel: #13969F;        /* 大きな枠組み (Box) */
  --text: #FFF8F3;         /* メインテキスト */
  --para: #B0C58B;         /* 補助テキスト */
  --btn: #F5B329;          /* Button背景 */
  --btnText: #13969F;      /* Button文字 */
  
  /* 透過・調整用 */
  --line: rgba(255, 248, 243, 0.2);
  --input-bg: rgba(0, 0, 0, 0.2); 
}

/* --- 基本スタイル --- */
* { box-sizing: border-box; }

body {
  margin: 0;
  background: var(--bg);
  color: var(--text);
  /* フォントをサンセリフ体で固定 */
  font-family: "Hiragino Kaku Gothic ProN", "ヒラギノ角ゴ ProN W3", "Meiryo", "メイリオ", sans-serif;
  line-height: 1.5;
}

/* 入力要素すべてにフォントを継承させる */
input, select, textarea, button {
  font-family: inherit;
  font-size: 14px;
  border-radius: 12px; /* 丸みを持たせる */
  outline: none;
}

header {
  padding: 16px 20px;
  border-bottom: 1px solid var(--line);
  background: rgba(0,0,0,0.1);
}
h1 { font-size: 18px; margin: 0; }
.sub { color: var(--para); font-size: 12px; }

/* --- メインレイアウト --- */
main {
  padding: 20px;
  display: grid;
  gap: 20px;
  grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
  max-width: 1200px;
  margin: 0 auto;
}

/* --- card (大きな枠組み) --- */
.card {
  background: var(--panel);
  border-radius: 20px; /* さらに丸くして可愛く */
  padding: 20px;
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
  border: 1px solid rgba(255,255,255,0.1);
}

.card h2 {
  font-size: 16px;
  margin: 0 0 16px;
  color: var(--text);
  display: flex;
  align-items: center;
  gap: 8px;
}

/* --- フォーム要素 --- */
label {
  display: block;
  font-size: 12px;
  color: var(--text);
  margin-bottom: 6px;
  font-weight: bold;
  opacity: 0.9;
}

input, select, textarea {
  width: 100%;
  padding: 10px 12px;
  background: var(--input-bg);
  border: 1px solid var(--line);
  color: var(--text);
  margin-bottom: 10px;
  transition: all 0.2s;
}

input:focus {
  border-color: var(--btn);
  background: rgba(0,0,0,0.3);
}

/* --- ボタン --- */
.btns { display: flex; flex-wrap: wrap; gap: 8px; }

button {
  cursor: pointer;
  padding: 10px 16px;
  border: 1px solid var(--line);
  background: rgba(255, 255, 255, 0.1);
  color: var(--text);
  font-weight: bold;
  transition: all 0.2s;
}

button:hover {
  background: rgba(255, 255, 255, 0.2);
}

button.primary {
  background: var(--btn);
  color: var(--btnText);
  border: none;
  box-shadow: 0 4px 0 rgba(0, 0, 0, 0.15);
}

button.primary:active {
  transform: translateY(2px);
  box-shadow: none;
}

button.danger{
  background:#D1671F;
  color:#F5B329;
  border:none;
  font-weight:700;
}

button.danger:hover{
  filter:brightness(1.1);
}


/* ===== 横並びリストUI ===== */
.list{
  display:flex;
  flex-direction:column;
  gap:0;
}

.item{
  display:grid;
  grid-template-columns: 2.2fr .8fr .6fr auto;
  align-items:center;
  gap:10px;
  padding:10px 4px;
  border-bottom:2px solid #0A7880;
  background:transparent;
  border-radius:0;
}

/* pillを少し軽く */
.item .pill{
  background:rgba(255,255,255,.12);
  font-size:10px;
}

/* 削除ボタン小さめ */
.item .danger{
  padding:6px 10px;
  border-radius:999px;
  font-size:12px;
}

/* JSで直書きされているスタイルへの対策 */
[style*="background: #0f1219"] {
  background: var(--input-bg) !important;
  border: 1px solid var(--line) !important;
  border-radius: 16px !important;
}

/* --- KPI / Pill --- */
.pill {
  background: rgba(255, 248, 243, 0.2);
  color: var(--text);
  font-size: 10px;
  padding: 2px 8px;
  border-radius: 20px;
  font-weight: normal;
}

.kpi { display: grid; gap: 10px; grid-template-columns: repeat(3, 1fr); margin-top: 15px; }
.kpi .box {
  background: rgba(0, 0, 0, 0.2);
  border-radius: 12px;
  padding: 12px;
  text-align: center;
}
.kpi .v { color: var(--btn); font-size: 24px; font-weight: 900; }
.kpi .name { font-size: 11px; opacity: 0.8; }
.kpi .desc { font-size: 9px; opacity: 0.6; }

/* --- その他 --- */
.full { grid-column: 1 / -1; }
textarea.mono { font-family: ui-monospace, monospace; }

details {
  border: 1px solid var(--line);
  border-radius: 12px;
  background: rgba(0,0,0,0.1);
}
    
/* ===== Traits: box内に枠を作らない / 折りたたみは維持 ===== */
#traitList{
  display: grid;
  gap: 10px;
}

/* detailsのデフォ枠を消す（box内box禁止） */
.traitDetails{
  border: none !important;
  background: transparent !important;
  padding: 0 !important;
}

/* summaryを“フォームの見出し行”っぽく */
.traitSummary{
  cursor: pointer;
  user-select: none;
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px 0;          /* 区切りの余白だけ */
  list-style: none;
}
.traitSummary::-webkit-details-marker{ display:none; }
.traitSummary::marker { content: ""; }

/* 開閉アイコン（控えめ） */
.traitSummary::before{
  content:"▶";
  display:inline-block;
  margin-right: 6px;
  color: rgba(255,248,243,.65);
  transform: translateY(-1px);
}
.traitDetails[open] .traitSummary::before{ content:"▼"; }

.traitSummaryTitle{
  font-weight: 800;
  color: var(--text);
}

/* 中身はちょいインデントで“階層”だけ出す */
.traitBody{
  padding-left: 18px;
  padding-top: 6px;
}

/* うっすら区切り線だけ（枠じゃない） */
.traitDetails + .traitDetails{
  border-top: 1px solid var(--line);
  padding-top: 10px;
}

/* ===== キャラメモ textarea をカードいっぱいに ===== */
.card:has(#memo){
  display: flex;
  flex-direction: column;
}

/* 高さは好みで。スマホ基準で見やすい値にしてる */
#memo{
  flex: 1;
  min-height: 380px;
  height: 100%;
  margin-bottom: 0;
}


/* full */
.full{ grid-column: 1 / -1; }

/* 特徴カードの見出し */
.traitTitle{
  margin: 0 0 10px;
  font-size: 14px;
  font-weight: 800;
  display: flex;
  align-items: center;
  gap: 8px;
}

/* スマホで3列きつい時は自動で縦積み */
@media (max-width: 560px){
  .traitRow{ grid-template-columns: 1fr !important; }
}

  </style>
</head>
<body>
<header>
  <h1>CSBM-TRPG キャラシ作成ツール</h1>
  <div class="sub">beta版</div>
</header>

<main>
  <!-- 基本情報カード -->
  <section class="card">
    <h2>
      基本情報
      <button id="btnResetAll" style="margin-left:auto;">全リセット</button>
    </h2>


    <div class="row2">
      <div>
        <label>名前</label>
        <input id="name" />
      </div>
      <div>
        <label>職業</label>
        <input id="role" />
      </div>
    </div>

    <div class="row3">
      <div>
        <label>年齢</label>
        <input id="age" type="number" min="0" step="1" />
      </div>
      <div>
        <label>性別</label>
        <select id="sex">
          <option value=""></option>
          <option value="男">男</option>
          <option value="女">女</option>
          <option value="その他">その他</option>
          <option value="不明">不明</option>
        </select>
      </div>
      <div>
        <label>身長（cm）</label>
        <input id="height" type="number" min="0" step="1" />
      </div>
    </div>

    <!-- ★ここ：閉じタグ修正＆misc追加 -->
    <div class="row2">
      <div>
        <label>誕生日（m/d）</label>
        <input id="birthday_md" />
      </div>
      <div></div>
    </div>

      
    <div class="btns" style="margin-top:12px;">
      <button class="primary" id="btnRandomProfile">プロフィールランダム</button>
    </div>
  </section>

  <!-- 能力値カード -->
  <section class="card">
    <h2>能力値<span class="pill">1~5</span></h2>

    <div class="row">
      <div><label>身体</label><input id="stat_body" type="number" min="1" max="5" value="3"></div>
      <div><label>知性</label><input id="stat_int"  type="number" min="1" max="5" value="3"></div>
      <div><label>社交</label><input id="stat_soc"  type="number" min="1" max="5" value="3"></div>
      <div><label>精神</label><input id="stat_spi"  type="number" min="1" max="5" value="3"></div>
      <div><label>運</label><input id="stat_luk"  type="number" min="1" max="5" value="3"></div>
    </div>

    <div class="btns" style="margin-top:12px;">
      <button class="primary" id="btnRandomStats">能力値ランダム</button>
    </div>

    <div class="kpi">
      <div class="box">
        <div class="name">HP</div>
        <div class="v" id="kpi_hp">-</div>
        <div class="desc">HP = 身体 + 精神 + 5</div>
      </div>
      <div class="box">
        <div class="name">DB</div>
        <div class="v" id="kpi_db">-</div>
        <div class="desc">DB = 身体 - 3</div>
      </div>
      <div class="box">
        <div class="name">MV</div>
        <div class="v" id="kpi_mv">-</div>
        <div class="desc">MV = 身体 + 運</div>
      </div>
    </div>
  </section>

  <!-- 特徴 -->
  <section class="card">
    <h2>特徴</h2>
    <div class="list" id="traitList"></div>
  </section>

  <!-- 得意分野 -->
  <section class="card">
    <h2>得意分野<span class="pill">+1</span></h2>

    <div class="row3">
      <div><label>名称</label><input id="good_name" /></div>
      <div>
        <label>ジャンル</label>
        <select id="good_cat">
          <option value="knowledge">知識</option>
          <option value="social">社交</option>
          <option value="support">支援</option>
          <option value="combat">戦闘</option>
          <option value="action">行動</option>
        </select>
      </div>
      <div style="align-self:end;"><button class="primary" id="btnAddGood" style="width:100%;">追加</button></div>
    </div>

    <div class="list" id="goodList"></div>
  </section>

  <!-- 苦手分野 -->
  <section class="card">
    <h2>苦手分野<span class="pill">-1</span></h2>

    <div class="row3">
      <div><label>名称</label><input id="bad_name" /></div>
      <div>
        <label>ジャンル</label>
        <select id="bad_cat">
          <option value="knowledge">知識</option>
          <option value="social">社交</option>
          <option value="support">支援</option>
          <option value="combat">戦闘</option>
          <option value="action">行動</option>
        </select>
      </div>
      <div style="align-self:end;"><button class="primary" id="btnAddBad" style="width:100%;">追加</button></div>
    </div>

    <div class="list" id="badList"></div>
  </section>

  <!-- 所持品 -->
  <section class="card">
    <h2>所持品 <span class="pill">最大3枠 / 合計+3</span></h2>

    <div class="row4">
      <div><label>名称</label><input id="item_name" /></div>
      <div>
        <label>ジャンル</label>
        <select id="item_cat">
          <option value="knowledge">知識</option>
          <option value="social">社交</option>
          <option value="support">支援</option>
          <option value="combat">戦闘</option>
          <option value="action">行動</option>
        </select>
      </div>
      <div>
        <label>補正pt</label>
        <select id="item_pt">
          <option value="0">0</option>
          <option value="1">+1</option>
          <option value="2">+2</option>
          <option value="3">+3</option>
        </select>
      </div>
      <div style="align-self:end;"><button class="primary" id="btnAddItem" style="width:100%;">追加</button></div>
    </div>

    <div class="list" id="itemList"></div>
    <div class="mini" id="itemCapInfo" style="margin-top:8px;"></div>
  </section>

  <!-- 関係 -->
  <section class="card">
    <h2>関係</h2>

    <div class="row4">
      <div><label>名前</label><input id="rel_name" /></div>
      <div><label>内容</label><input id="rel_note" /></div>
      <div>
        <label>重要度</label>
        <select id="rel_val">
          <option value="-3">-3</option><option value="-2">-2</option><option value="-1">-1</option>
          <option value="0" selected>0</option>
          <option value="1">+1</option><option value="2">+2</option><option value="3">+3</option>
        </select>
      </div>
      <div style="align-self:end;"><button class="primary" id="btnAddRel" style="width:100%;">追加</button></div>
    </div>

    <div class="list" id="relList"></div>
  </section>

  <!-- キャラメモ -->
  <section class="card">
    <h2>キャラメモ</h2>
    <textarea id="memo" class="mono"></textarea>
  </section>

  <!-- チャパレ -->
  <section class="card full">
    <h2>チャパレ（ココフォリア用）</h2>
    <div class="row2">
      <div>
        <label>環境補正（固定値）</label>
        <input id="env_fixed" type="number" value="0" min="-3" max="3" />
        <label>関係補正を適用する対象名（任意）</label>
        <input id="rel_target" />

        <div class="btns">
          <button class="primary" id="btnMakePalette">チャパレ生成</button>
          <button id="btnCopy">コピー</button>
        </div>
      </div>

      <div>
        <label>出力</label>
        <textarea id="palette" class="mono" readonly></textarea>
      </div>
    </div>
  </section>

  <!-- JSON -->
  <section class="card full">
    <h2>JSON保存 / 読込</h2>
    <div class="row2">
      <div>
        <label>保存</label>
        <textarea id="json_out" class="mono" readonly></textarea>
        <div class="btns">
          <button id="btnSave">JSON生成</button>
        </div>
      </div>
      <div>
        <label>読込</label>
        <textarea id="json_in" class="mono"></textarea>
        <div class="btns">
          <button class="primary" id="btnLoad">JSON読込</button>
        </div>
      </div>
    </div>
  </section>
</main>

<script>
// ===== autosave =====
const STORAGE_KEY = "csbm_trpg_charsheet_v1";
let autosaveTimer = null;

function getSaveData(){
  return {
    name: $("name").value||"",
    role: $("role").value||"",
    age: $("age").value ? Number($("age").value) : null,
    sex: $("sex").value||"",
    height: $("height").value ? Number($("height").value) : null,
    birthday_md: $("birthday_md").value||"",
    memo: $("memo").value||"",
    stats: getStats(),
    env_fixed: Number($("env_fixed").value||0),
    goods: state.goods,
    bads: state.bads,
    items: state.items,
    rels: state.rels,
    traits: state.traits
  };
}

function applySaveData(data){
  $("name").value = data.name ?? "";
  $("role").value = data.role ?? "";
  $("age").value = (data.age ?? null) === null ? "" : (data.age ?? "");
  $("sex").value = data.sex ?? "";
  $("height").value = (data.height ?? null) === null ? "" : (data.height ?? "");
  $("birthday_md").value = data.birthday_md ?? "";
  $("memo").value = data.memo ?? "";

  const st = data.stats ?? {};
  $("stat_body").value = st.body ?? 3;
  $("stat_int").value  = st.intel ?? 3;
  $("stat_soc").value  = st.soc ?? 3;
  $("stat_spi").value  = st.spi ?? 3;
  $("stat_luk").value  = st.luk ?? 3;

  $("env_fixed").value = data.env_fixed ?? 0;

  state.goods = Array.isArray(data.goods) ? data.goods : [];
  state.bads  = Array.isArray(data.bads)  ? data.bads  : [];
  state.items = Array.isArray(data.items) ? data.items : [];
  state.rels  = Array.isArray(data.rels)  ? data.rels  : [];
  state.traits= Array.isArray(data.traits)? data.traits: [];

  ensureDefaultTraits();
}

function saveToLocal(){
  try{
    localStorage.setItem(STORAGE_KEY, JSON.stringify(getSaveData()));
  }catch(e){
    // 容量超過/プライベートブラウズ等
  }
}

function scheduleAutosave(){
  if(autosaveTimer) clearTimeout(autosaveTimer);
  autosaveTimer = setTimeout(saveToLocal, 250);
}

function loadFromLocal(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return false;
    const data = JSON.parse(raw);
    applySaveData(data);
    return true;
  }catch(e){
    return false;
  }
}

/** helpers **/
const $ = (id)=>document.getElementById(id);
const clamp = (n,min,max)=>Math.max(min, Math.min(max, n));
const sign = (n)=> n>0?"+":(n<0?"-":"");
const catLabel = (c)=>({ knowledge:"知識", social:"社交", support:"支援", combat:"戦闘", action:"行動" }[c] ?? c);
function ptsToDieSize(pt){
  const neg = pt < 0;
  const a = Math.abs(pt);
  if(a <= 0) return { die:null, neg:false };
  if(a <= 2) return { die:2, neg };
  if(a <= 4) return { die:4, neg };
  return { die:6, neg };
}
function fmtDie(dieObj){
  if(!dieObj.die) return "";
  return (dieObj.neg ? "-1d" : "+1d") + dieObj.die;
}
function sumBy(list, fn){ return list.reduce((acc,x)=>acc+fn(x),0); }
function escAttr(s){
  return String(s ?? "").replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
}

/** state **/
const state = { goods:[], bads:[], items:[], rels:[], traits:[] };

function ensureDefaultTraits(){
  if(!Array.isArray(state.traits)) state.traits = [];
  const beliefs = state.traits.filter(t=>t.type==="belief").slice(0,2);
  const flaws   = state.traits.filter(t=>t.type==="flaw").slice(0,1);
  while(beliefs.length < 2) beliefs.push({ type:"belief", text:"", detail:"", target:"action" });
  while(flaws.length < 1)   flaws.push({ type:"flaw",   text:"", detail:"", target:"action" });
  state.traits = [...beliefs, ...flaws].map(t=>({ type:t.type, text:t.text??"", detail:t.detail??"", target:t.target??"action" }));
}
function traitTargetLabel(t){
  return ({ research:"調査ダイス", social:"社交ダイス", support:"支援ダイス", attack:"攻撃ダイス", action:"行動ダイス", ability:"能力ダイス" }[t] ?? t);
}

/** render **/
function renderGoods(){
  const box = $("goodList"); box.innerHTML = "";

  state.goods.forEach((s, idx)=>{
    const row = document.createElement("div");
    row.className = "item";

    row.innerHTML = `
      <div class="mono">${escAttr(s.name)}</div>
      <div><span class="pill">${catLabel(s.cat)}</span></div>
      <div class="mini">+1</div>
      <div><button class="danger" data-del-good="${idx}">削除</button></div>
    `;

    box.appendChild(row);
  });

  box.querySelectorAll("[data-del-good]").forEach(btn=>{
    btn.onclick = ()=>{ state.goods.splice(Number(btn.dataset.delGood),1); recalcAll(); };
  });
}
function renderBads(){
  const box = $("badList"); box.innerHTML = "";

  state.bads.forEach((s, idx)=>{
    const row = document.createElement("div");
    row.className = "item";

    row.innerHTML = `
      <div class="mono">${escAttr(s.name)}</div>
      <div><span class="pill">${catLabel(s.cat)}</span></div>
      <div class="mini">-1</div>
      <div><button class="danger" data-del-bad="${idx}">削除</button></div>
    `;

    box.appendChild(row);
  });

  box.querySelectorAll("[data-del-bad]").forEach(btn=>{
    btn.onclick = ()=>{ state.bads.splice(Number(btn.dataset.delBad),1); recalcAll(); };
  });
}
function renderItems(){
  const box = $("itemList"); box.innerHTML = "";

  state.items.forEach((it, idx)=>{
    const row = document.createElement("div");
    row.className = "item";

    row.innerHTML = `
      <div class="mono">${escAttr(it.name)}</div>
      <div><span class="pill">${catLabel(it.cat)}</span></div>
      <div class="mini">${it.pt>=0?"+":""}${it.pt}</div>
      <div><button class="danger" data-del-item="${idx}">削除</button></div>
    `;

    box.appendChild(row);
  });

  box.querySelectorAll("[data-del-item]").forEach(btn=>{
    btn.onclick = ()=>{ state.items.splice(Number(btn.dataset.delItem),1); recalcAll(); };
  });

  const totalPt = sumBy(state.items, x=>Number(x.pt||0));
  $("itemCapInfo").textContent =
    `枠 ${state.items.length}/3、補正pt合計 ${totalPt}/3`;
}

function renderRels(){
  const box = $("relList"); box.innerHTML = "";

  state.rels.forEach((r, idx)=>{
    const row = document.createElement("div");
    row.className = "item";

    row.innerHTML = `
      <div class="mono">${escAttr(r.name)}</div>
      <div>${escAttr(r.note||"")}</div>
      <div class="mini">${r.val>=0?"+":""}${r.val}</div>
      <div><button class="danger" data-del-rel="${idx}">削除</button></div>
    `;

    box.appendChild(row);
  });

  box.querySelectorAll("[data-del-rel]").forEach(btn=>{
    btn.onclick = ()=>{ state.rels.splice(Number(btn.dataset.delRel),1); recalcAll(); };
  });
}

function renderTraits(){
  ensureDefaultTraits();
  const box = $("traitList"); box.innerHTML = "";

  state.traits.forEach((t, idx)=>{
    const title = (t.type==="belief") ? "信条" : "欠陥";
    const badge = (t.type==="belief") ? "+1d6" : "-1d6";

    const wrap = document.createElement("details");
    wrap.className = "traitDetails";
    wrap.open = true; // 初期は開いててOK。閉じたいなら false に

    wrap.innerHTML = `
      <summary class="traitSummary">
        <span class="traitSummaryTitle">${title}</span>
        <span class="pill">${badge}</span>
      </summary>

      <div class="row3 traitBody">
        <div>
          <label>${title}</label>
          <input data-trait-text="${idx}" value="${escAttr(t.text)}" />
        </div>

        <div>
          <label>対象</label>
          <select data-trait-target="${idx}">
            ${["research","social","support","attack","action","ability"].map(k=>`
              <option value="${k}" ${t.target===k?"selected":""}>${traitTargetLabel(k)}</option>
            `).join("")}
          </select>
        </div>

        <div></div>
      </div>

      <div class="traitBody">
        <label>詳細メモ</label>
        <textarea data-trait-detail="${idx}" class="mono" style="min-height:90px;">${t.detail ?? ""}</textarea>
      </div>
    `;

    box.appendChild(wrap);
  });

  // events
  box.querySelectorAll("[data-trait-target]").forEach(sel=>{
    sel.onchange = ()=>{
      const idx = Number(sel.dataset.traitTarget);
      state.traits[idx].target = sel.value;
      recalcAll();
    };
  });
  box.querySelectorAll("[data-trait-text]").forEach(inp=>{
    inp.oninput = ()=>{
      const idx = Number(inp.dataset.traitText);
      state.traits[idx].text = inp.value;
      makePalette(); makeJsonOut();
    };
  });
  box.querySelectorAll("[data-trait-detail]").forEach(ta=>{
    ta.oninput = ()=>{
      const idx = Number(ta.dataset.traitDetail);
      state.traits[idx].detail = ta.value;
      makeJsonOut();
    };
  });
}

/** compute **/
function getStats(){
  const body = clamp(Number($("stat_body").value||3),1,5);
  const intel= clamp(Number($("stat_int").value||3),1,5);
  const soc  = clamp(Number($("stat_soc").value||3),1,5);
  const spi  = clamp(Number($("stat_spi").value||3),1,5);
  const luk  = clamp(Number($("stat_luk").value||3),1,5);
  return { body, intel, soc, spi, luk };
}
function computeDerived(stats){
  const hp = stats.body + stats.spi + 5;
  const db = stats.body - 3;
  const mv = stats.body + stats.luk;
  return { hp, db, mv };
}
function bonusPtsForCategory(cat){
  const goodPt = sumBy(state.goods.filter(s=>s.cat===cat), ()=> 1);
  const badPt  = sumBy(state.bads.filter(s=>s.cat===cat),  ()=> -1);
  const itemPt = sumBy(state.items.filter(i=>i.cat===cat),  i=> Number(i.pt||0));
  return goodPt + badPt + itemPt;
}
function traitDieFor(targetKey){
  let die = 0;
  state.traits.forEach(t=>{
    if(t.target !== targetKey) return;
    die += (t.type==="belief" ? 1 : -1);
  });
  if(die === 0) return "";
  const abs = Math.abs(die);
  const s = die>0 ? "+" : "-";
  return `${s}${abs}d6`;
}
function relFixedForTargetName(name){
  if(!name) return 0;
  const r = state.rels.find(x=>x.name === name);
  return r ? Number(r.val||0) : 0;
}
function makeDiceExpr(){
  const stats = getStats();
  const env = clamp(Number($("env_fixed").value||0), -3, 3);
  const relTarget = ($("rel_target").value||"").trim();
  const rel = relFixedForTargetName(relTarget);

  const ptsK = bonusPtsForCategory("knowledge");
  const ptsS = bonusPtsForCategory("social");
  const ptsSu= bonusPtsForCategory("support");
  const ptsC = bonusPtsForCategory("combat");
  const ptsA = bonusPtsForCategory("action");

  const dieK = fmtDie(ptsToDieSize(ptsK));
  const dieS = fmtDie(ptsToDieSize(ptsS));
  const dieSu= fmtDie(ptsToDieSize(ptsSu));
  const dieC = fmtDie(ptsToDieSize(ptsC));
  const dieA = fmtDie(ptsToDieSize(ptsA));

  const tResearch = traitDieFor("research");
  const tSocial   = traitDieFor("social");
  const tSupport  = traitDieFor("support");
  const tAttack   = traitDieFor("attack");
  const tAction   = traitDieFor("action");
  const tAbility  = traitDieFor("ability");

  const envStr = env ? `${sign(env)}${Math.abs(env)}` : "";

  const research = `2d6+1d${stats.intel}${dieK}${envStr}${tResearch}`;
  const socialEx = `2d6+1d${stats.soc}${dieS}${envStr}${tSocial}${rel?`${sign(rel)}${Math.abs(rel)}`:""}`;
  const support  = `2d6+1d${stats.intel}${dieSu}${envStr}${tSupport}${rel?`${sign(rel)}${Math.abs(rel)}`:""}`;
  const attack   = `2d6+1d${stats.body}${dieC}${envStr}${tAttack}`;
  const action   = `2d6+1d${computeDerived(stats).mv}${dieA}${envStr}${tAction}`;
  const ability  = `2d6+1d${stats.intel}+${stats.intel}${envStr}${tAbility}`;

  return { research, socialEx, support, attack, action, ability, env, relTarget, rel };
}

function recalcAll(){
  renderTraits();
  renderGoods();
  renderBads();
  renderItems();
  renderRels();

  const d = computeDerived(getStats());
  $("kpi_hp").textContent = d.hp;
  $("kpi_db").textContent = (d.db>=0?("+"+d.db):String(d.db));
  $("kpi_mv").textContent = d.mv;

  makePalette();
  makeJsonOut();

  scheduleAutosave();
}

function makePalette(){
  const d = computeDerived(getStats());
  const ex = makeDiceExpr();

  const nm = ($("name").value||"").trim();
  const role = ($("role").value||"").trim();
  const age = $("age").value ? String($("age").value) : "";
  const sex = ($("sex").value||"").trim();
  const h   = $("height").value ? String($("height").value) : "";
  const bd  = ($("birthday_md").value||"").trim();

  const lines = [];
  lines.push(`// CSBM-TRPG チャパレ${nm ? "：" + nm : ""}`);
  const profileBits = [];
  if(role) profileBits.push(role);
  const a = [];
  if(age) a.push(age+"歳");
  if(sex) a.push(sex);
  if(h) a.push(h+"cm");
  if(bd) a.push("BD:"+bd);
  if(a.length) profileBits.push(a.join(" / "));
  if(profileBits.length) lines.push(`// ${profileBits.join(" / ")}`);

  lines.push(`// HP:${d.hp} DB:${d.db>=0?"+":""}${d.db} MV:${d.mv}`);
  if(ex.relTarget) lines.push(`// 関係補正対象：${ex.relTarget} (${ex.rel>=0?"+":""}${ex.rel})`);
  if(ex.env) lines.push(`// 環境補正：${ex.env>=0?"+":""}${ex.env}`);

  lines.push(`調査 ${ex.research}`);
  lines.push(`社交 ${ex.socialEx}`);
  lines.push(`支援 ${ex.support}`);
  lines.push(`攻撃 ${ex.attack}`);
  lines.push(`行動 ${ex.action}`);
  lines.push(`能力 ${ex.ability}`);

  lines.push(`// 戦闘`);
  lines.push(`命中 ${ex.attack}>=9`);
  lines.push(`回避 ${ex.action}>=`);
  lines.push(`庇う ${ex.action}>=9`);
  lines.push(`回復 ${ex.support}>=9`);
  lines.push(`ダメ 1d3${d.db? (d.db>0?`+${d.db}`:`${d.db}`):""}`);

  $("palette").value = lines.join("\n");
}

function makeJsonOut(){
  const data = {
    name: $("name").value||"",
    role: $("role").value||"",
    age: $("age").value ? Number($("age").value) : null,
    sex: $("sex").value||"",
    height: $("height").value ? Number($("height").value) : null,
    birthday_md: $("birthday_md").value||"",
    memo: $("memo").value||"",
    stats: getStats(),
    env_fixed: Number($("env_fixed").value||0),
    goods: state.goods,
    bads: state.bads,
    items: state.items,
    rels: state.rels,
    traits: state.traits
  };
  $("json_out").value = JSON.stringify(data, null, 2);
}

/** random **/
function randomStatsSum15(){
  for(let tries=0; tries<20000; tries++){
    const arr = Array.from({length:5}, ()=> 1 + Math.floor(Math.random()*5));
    const sum = arr.reduce((a,b)=>a+b,0);
    if(sum === 15) return arr;
  }
  return [3,3,3,3,3];
}
function randInt(min, maxInclusive){
  return min + Math.floor(Math.random() * (maxInclusive - min + 1));
}
function randomProfile(){
  const age = randInt(16, 60);
  const height = randInt(140, 200);
  const sexes = ["男","女","その他"];
  const sex = sexes[randInt(0, sexes.length-1)];
  const month = randInt(1,12);
  const dayMax = new Date(2024, month, 0).getDate();
  const day = randInt(1, dayMax);
  const birthday_md = `${month}/${day}`;
  return { age, height, sex, birthday_md };
}

/** add rules **/
function tryAddItem({name, cat, pt}){
  const n = (name||"").trim();
  if(!n) return false;

  if(state.items.length >= 3){
    alert("所持品は最大3枠");
    return false;
  }

  const currentTotal = sumBy(state.items, x=>Number(x.pt||0));
  const nextTotal = currentTotal + Number(pt||0);
  if(nextTotal > 3){
    alert("所持品pt合計は最大+3");
    return false;
  }

  state.items.push({ name:n, cat, pt:Number(pt||0) });
  return true;
}

/** events **/
$("btnResetAll").onclick = ()=>{
  if(!confirm("すべての入力をリセットします。よろしい？")) return;

  localStorage.removeItem(STORAGE_KEY);

  // state初期化
  state.goods = [];
  state.bads = [];
  state.items = [];
  state.rels = [];
  state.traits = [];

  // 入力初期化
  ["name","role","age","sex","height","birthday_md","memo","rel_target"]
    .forEach(id=> $(id).value = "");

  $("env_fixed").value = 0;

  $("stat_body").value = 3;
  $("stat_int").value  = 3;
  $("stat_soc").value  = 3;
  $("stat_spi").value  = 3;
  $("stat_luk").value  = 3;

  ensureDefaultTraits();
  recalcAll();
};

$("btnAddGood").onclick = ()=>{
  const n = ($("good_name").value||"").trim();
  if(!n) return;
  state.goods.push({ name:n, cat:$("good_cat").value });
  $("good_name").value="";
  recalcAll();
};
$("btnAddBad").onclick = ()=>{
  const n = ($("bad_name").value||"").trim();
  if(!n) return;
  state.bads.push({ name:n, cat:$("bad_cat").value });
  $("bad_name").value="";
  recalcAll();
};
$("btnAddItem").onclick = ()=>{
  const ok = tryAddItem({ name:$("item_name").value, cat:$("item_cat").value, pt:Number($("item_pt").value||0) });
  if(ok){ $("item_name").value=""; recalcAll(); }
};
$("btnAddRel").onclick = ()=>{
  const name = ($("rel_name").value||"").trim();
  if(!name) return;
  state.rels.push({ name, note:($("rel_note").value||"").trim(), val:Number($("rel_val").value||0) });
  $("rel_name").value = ""; $("rel_note").value = ""; $("rel_val").value = "0";
  recalcAll();
};

$("btnMakePalette").onclick = makePalette;
$("btnCopy").onclick = async ()=>{
  try{ await navigator.clipboard.writeText($("palette").value); alert("コピーした"); }
  catch(e){ alert("コピー失敗"); }
};

$("btnRandomStats").onclick = ()=>{
  const [b,i,s,sp,l] = randomStatsSum15();
  $("stat_body").value = b;
  $("stat_int").value  = i;
  $("stat_soc").value  = s;
  $("stat_spi").value  = sp;
  $("stat_luk").value  = l;
  recalcAll();
};

$("btnRandomProfile").onclick = ()=>{
  const p = randomProfile();
  $("age").value = p.age;
  $("sex").value = p.sex;
  $("height").value = p.height;
  $("birthday_md").value = p.birthday_md;
  recalcAll();
};

["stat_body","stat_int","stat_soc","stat_spi","stat_luk","env_fixed","rel_target","name","role","age","sex","height","birthday_md","memo"]
  .forEach(id=> $(id).addEventListener("input", recalcAll));

$("btnSave").onclick = makeJsonOut;
$("btnLoad").onclick = ()=>{
  try{
    const data = JSON.parse(($("json_in").value||"").trim());
    $("name").value = data.name ?? "";
    $("role").value = data.role ?? "";
    $("age").value = (data.age ?? "") === null ? "" : (data.age ?? "");
    $("sex").value = data.sex ?? "";
    $("height").value = (data.height ?? "") === null ? "" : (data.height ?? "");
    $("birthday_md").value = data.birthday_md ?? "";
    $("memo").value = data.memo ?? "";

    const st = data.stats ?? {};
    $("stat_body").value = st.body ?? 3;
    $("stat_int").value  = st.intel ?? 3;
    $("stat_soc").value  = st.soc ?? 3;
    $("stat_spi").value  = st.spi ?? 3;
    $("stat_luk").value  = st.luk ?? 3;

    $("env_fixed").value = data.env_fixed ?? 0;

    state.goods = Array.isArray(data.goods) ? data.goods : [];
    state.bads  = Array.isArray(data.bads)  ? data.bads  : [];
    state.items = Array.isArray(data.items) ? data.items : [];
    state.rels  = Array.isArray(data.rels)  ? data.rels  : [];
    state.traits= Array.isArray(data.traits)? data.traits: [];

    ensureDefaultTraits();
    recalcAll();
  }catch(e){
    alert("JSON読込失敗");
  }
};

// init
ensureDefaultTraits();
loadFromLocal();
recalcAll();

window.addEventListener("beforeunload", saveToLocal);
</script>
</body>
</html>
