<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>フィップス キャラガチャ</title>

  <!-- Font -->
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Zen+Kaku+Gothic+New:wght@900&display=swap');
  </style>

  <!-- html2canvas (結果カードを画像保存) / ネット必要。不要なら削除OK -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <style>
    :root{
      --bg:#F6FCFA;
      --line:#DDEDF1;
      --title:#3D7C8D;
      --muted:#89AFB9;
      --btn:#34C38E;
      --accent:#F37679;

      --card:#3D7C8D;
      --cardLine:#A0C0C8;
      --cardName:#DDEDF1;
      --cardYomi:#89AFB9;
      --cardDivider:#4F8898;

      --resetBorder:#DDEDF1;
      --resetText:#89AFB9;

      --soft:#DDEDF1;
      --softText:#89AFB9;
      --placeholder:#BBD1D6;
      --white75: rgba(255,255,255,.75);
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      background:var(--bg);
      color:var(--title);
      font-family:"Zen Kaku Gothic New", system-ui, -apple-system, sans-serif;
      font-weight:900;
      letter-spacing:.02em;
    }

    /* 1 header */
    header{
      padding:14px 16px 8px;
      text-align:center;
      color:#BCCDD1;
      font-size:18px;
    }

    .wrap{
      width:min(980px, 94vw);
      margin:0 auto;
      padding:6px 0 26px;
    }

    /* Section lines */
    .section-line{
      height:2px;
      background:var(--line);
      border-radius:999px;
      margin:18px 0;
    }

    /* 2 title */
    .hero{
      text-align:center;
      padding:8px 0 4px;
    }
    .hero h1{
      margin:10px 0 6px;
      font-size: clamp(34px, 5vw, 56px);
      line-height:1.15;
      color:var(--title);
    }
    /* 3 total */
    .hero .total{
      color:var(--muted);
      font-size: clamp(18px, 2.6vw, 28px);
      margin-top: 6px;
    }

    /* 4 gacha button */
    .cta{
      display:flex;
      justify-content:center;
      margin:18px 0 10px;
    }
    .btn{
      border:none;
      border-radius:10px;
      padding:18px 44px;
      font-size: clamp(22px, 3vw, 34px);
      font-family:"Zen Kaku Gothic New", system-ui, -apple-system, sans-serif;
      font-weight:900;
      cursor:pointer;
      user-select:none;
      transition: transform .08s ease;
    }
    .btn:active{ transform: translateY(1px) scale(.99); }
    .btn-gacha{
      background:var(--btn);
      color:var(--bg);
      width: min(520px, 86vw);
      box-shadow:none;
    }

    /* 5 result card shell */
    .result-area{ margin-top: 6px; }
    .card{
      background:var(--card);
      border-radius:22px;
      padding:16px;
      position:relative;
      display:grid;
      grid-template-columns: 260px 1fr;
      gap:16px;
      align-items:stretch;
    }
    @media (max-width: 720px){
      .card{ grid-template-columns: 1fr; }
    }

    /* 18,19 top-right */
    .card-actions{
      position:absolute;
      right:14px;
      top:12px;
      display:flex;
      gap:10px;
      align-items:center;
    }
    .chip-btn{
      background:var(--soft);
      color:var(--title);
      border:none;
      border-radius:10px;
      padding:8px 12px;
      font-size:16px;
      cursor:pointer;
      line-height:1;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .chip-btn svg{ width:20px; height:20px; }
    .chip-btn:active{ transform: translateY(1px); }

    /* 6 image box */
    .portrait{
      border-radius:18px;
      padding:12px;
      position:relative;
      overflow:hidden;
      display:flex;
      flex-direction:column;
      gap:10px;
      min-height: 260px;
    }
    .portrait::after{
      content:"";
      position:absolute;
      inset:0;
      background: linear-gradient(to bottom, rgba(255,255,255,.08), rgba(255,255,255,.0) 50%, rgba(255,255,255,.12));
      pointer-events:none;
    }
    .portrait-inner{
      position:relative;
      z-index:1;
      background: rgba(255,255,255,.0);
      border-radius:14px;
      display:flex;
      align-items:center;
      justify-content:center;
      width:100%;
      aspect-ratio:1/1;
      overflow:hidden;
    }
    .portrait-inner img{
      width:100%;
      height:100%;
      object-fit:contain;
      display:block;

      /* 太め縁どり：drop-shadow多段 */
      filter:
        drop-shadow( 3px  0px 0 var(--white75))
        drop-shadow(-3px  0px 0 var(--white75))
        drop-shadow( 0px  3px 0 var(--white75))
        drop-shadow( 0px -3px 0 var(--white75))
        drop-shadow( 2px  2px 0 var(--white75))
        drop-shadow(-2px  2px 0 var(--white75))
        drop-shadow( 2px -2px 0 var(--white75))
        drop-shadow(-2px -2px 0 var(--white75));
    }
    .no-image{
      width:100%;
      height:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      color:var(--bg);
      font-size:24px;
      opacity:.95;
    }

    /* 7 name block */
    .nameblock{
      z-index:1;
      position:relative;
      text-align:center;
    }
    .name-yomi{
      color:var(--cardYomi);
      font-size: 18px;
      margin:0 0 8px;
      letter-spacing:.06em;
    }
    .name-divider{
      height:2px;
      background:var(--cardDivider);
      border-radius:999px;
      margin:0 auto 8px;
      width:92%;
    }
    .name-main{
      color:var(--cardName);
      font-size: 44px; /* JSでフィットさせる */
      line-height:1.05;
      margin:0;
      white-space:nowrap;
      overflow:hidden;
    }

    /* right panel */
    .info{
      background: rgba(255,255,255,.22);
      border-radius:18px;
      padding:14px 14px 12px;
      display:flex;
      flex-direction:column;
      gap:10px;
      overflow:hidden;
    }

    /* 8 series */
    .series{
      color:var(--muted);
      font-size: 36px; /* JSでフィット */
      line-height:1.1;
      white-space:nowrap;
      overflow:hidden;
    }
    .series small{
      font-size:.55em;
      margin-right:10px;
      opacity:.9;
    }

    /* 9 kv rows */
    .kv{
      display:grid;
      grid-template-columns: 150px 1fr;
      gap:6px 12px;
      align-items:center;
      padding-top:6px;
    }
    .kv .k{
      color:var(--title);
      font-size:20px;
      opacity:.95;
    }
    .kv .v{
      color:var(--cardName);
      font-size:20px;
      justify-self:start;
    }
    .kv-line{
      grid-column:1/-1;
      height:2px;
      background:var(--cardLine);
      border-radius:999px;
      margin:4px 0;
      opacity:.9;
    }
    .personality{
      margin-top:6px;
      display:grid;
      grid-template-columns: 150px 1fr;
      gap:8px 12px;
      align-items:start;
    }
    .personality .k{
      color:var(--title);
      font-size:20px;
    }
    .personality .v{
      color:var(--cardName);
      font-size:20px;
      line-height:1.35;
      display:-webkit-box;
      -webkit-line-clamp:3;   /* 3行まで */
      -webkit-box-orient:vertical;
      overflow:hidden;
      white-space:pre-wrap;
    }

    /* 10 filter header */
    .filters-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
      padding:2px 4px;
    }
    .filters-head .label{
      color:var(--accent);
      font-size:32px;
    }
    .btn-reset{
      background:var(--accent);
      color:var(--resetText);
      border:3px solid var(--resetBorder);
      border-radius:12px;
      padding:10px 18px;
      font-size:20px;
      cursor:pointer;
    }

    /* Filters layout */
    .filters{
      display:grid;
      grid-template-columns: 1.05fr .95fr;
      gap:14px;
      align-items:start;
    }
    @media (max-width: 820px){
      .filters{ grid-template-columns:1fr; }
    }

    /* 11,12 left */
    .filter-left{
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .field{
      display:grid;
      grid-template-columns: 160px 1fr;
      gap:10px;
      align-items:center;
    }
    .field .k{
      color:var(--muted);
      font-size:22px;
    }

    /* flat input */
    .control{
      background:var(--soft);
      border:none;
      border-radius:10px;
      min-height:48px;
      padding:10px 12px;
      color:var(--softText);
      font-size:20px;
      font-family:"Zen Kaku Gothic New", system-ui, -apple-system, sans-serif;
      font-weight:900;
      outline:none;
    }

    /* multi select button */
    .multi{
      position:relative;
    }
    .multi-btn{
      width:100%;
      text-align:left;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .multi-btn .placeholder{
      color:var(--placeholder);
    }
    .caret{
      width:0; height:0;
      border-left:8px solid transparent;
      border-right:8px solid transparent;
      border-top:10px solid var(--btn); /* 11 arrow color */
      margin-left:auto;
      flex:0 0 auto;
    }
    .multi-panel{
      position:absolute;
      left:0; right:0;
      top: calc(100% + 8px);
      background:var(--soft);
      border-radius:12px;
      padding:10px;
      display:none;
      z-index:50;
      box-shadow:none;
      max-height: 240px;
      overflow:auto;
      border:2px solid rgba(61,124,141,.18);
    }
    .multi.open .multi-panel{ display:block; }
    .opt{
      display:flex;
      align-items:center;
      gap:10px;
      padding:8px 8px;
      border-radius:10px;
      cursor:pointer;
      user-select:none;
      color:var(--title);
      font-size:20px;
    }
    .opt:hover{ background: rgba(52,195,142,.15); }
    .tick{
      width:22px; height:22px;
      border-radius:6px;
      border:3px solid var(--btn);
      background:transparent;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      flex:0 0 auto;
    }
    .tick.on{
      background: var(--btn);
    }
    .tick.on::after{
      content:"";
      width:10px; height:6px;
      border-left:3px solid var(--bg);
      border-bottom:3px solid var(--bg);
      transform: rotate(-45deg) translateY(-1px);
    }

    /* 12 range */
    .range-wrap{
      display:grid;
      grid-template-columns: 1fr 40px 1fr;
      gap:8px;
      align-items:center;
    }
    .range-wrap .sep{
      text-align:center;
      color:var(--placeholder);
      font-size:22px;
    }
    .control::placeholder{
      color:var(--placeholder);
      opacity:1;
    }

    /* 13 color picker */
    .color-box{
      background:var(--soft);
      border-radius:12px;
      padding:12px;
      display:flex;
      align-items:center;
      gap:12px;
      cursor:pointer;
      user-select:none;
    }
    .color-box img{
      width:90px;
      height:90px;
      object-fit:contain;
      display:block;
    }
    .color-sel{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
      color:var(--softText);
      font-size:18px;
    }
    .pill{
      background: rgba(52,195,142,.15);
      border:2px solid rgba(52,195,142,.35);
      color:var(--title);
      border-radius:999px;
      padding:6px 10px;
      font-size:18px;
      line-height:1;
    }

    /* 14 toggles + 15/16 right */
    .filter-right{
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .toggle{
      background:var(--soft);
      border-radius:12px;
      padding:14px 16px;
      display:flex;
      align-items:center;
      gap:12px;
      cursor:pointer;
      user-select:none;
      color:var(--title);
      font-size:22px;
    }
    .radio{
      width:22px; height:22px;
      border-radius:999px;
      border:4px solid var(--btn);
      display:inline-block;
      flex:0 0 auto;
      background:transparent;
    }
    .radio.on{
      background: var(--btn);
    }

    /* 15 hits */
    .hits{
      display:flex;
      align-items:baseline;
      justify-content:flex-end;
      gap:12px;
      color:var(--btn);
      font-size:28px;
      padding:2px 4px 0;
    }

    /* 16 list */
    .hitlist{
      background:var(--card);
      border:3px solid var(--card);
      border-radius:14px;
      padding:10px;
      max-height: 150px;
      overflow:auto;
    }
    .hitgrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:8px 10px;
    }
    .hitname{
      background: rgba(255,255,255,.10);
      border-radius:10px;
      padding:8px 10px;
      color:var(--bg); /* ここは見本画像の雰囲気に合わせて読みやすく */
      font-size:18px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    /* スクロールバー(できる範囲で) */
    .hitlist::-webkit-scrollbar{ width:10px; }
    .hitlist::-webkit-scrollbar-track{ background: rgba(255,255,255,.10); border-radius:999px; }
    .hitlist::-webkit-scrollbar-thumb{ background: var(--btn); border-radius:999px; }

    /* 17 bottom button */
    .bottom{
      display:flex;
      justify-content:center;
      margin-top:16px;
    }
    .btn-list{
      background:var(--accent);
      color:var(--cardName);
      border:none;
      border-radius:12px;
      padding:18px 34px;
      width:min(520px, 86vw);
      font-size:28px;
      cursor:pointer;
    }

    /* simple toast */
    .toast{
      position:fixed;
      left:50%;
      bottom:24px;
      transform:translateX(-50%);
      background: rgba(61,124,141,.92);
      color: var(--bg);
      padding:12px 16px;
      border-radius:12px;
      font-size:18px;
      display:none;
      z-index:999;
      max-width:min(560px, 92vw);
      text-align:center;
    }
    .toast.show{ display:block; }

    /* modal for color picker */
    .modal{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.25);
      display:none;
      z-index:200;
      align-items:center;
      justify-content:center;
      padding:18px;
    }
    .modal.open{ display:flex; }
    .modal-panel{
      width:min(520px, 92vw);
      background: var(--soft);
      border-radius:16px;
      padding:14px;
      border:2px solid rgba(61,124,141,.18);
    }
    .modal-title{
      color:var(--title);
      font-size:22px;
      margin:6px 6px 10px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }
    .xbtn{
      border:none;
      background:transparent;
      color:var(--title);
      font-size:26px;
      cursor:pointer;
      padding:6px 10px;
    }
    .color-grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      padding:6px;
    }
    .color-item{
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px;
      border-radius:12px;
      cursor:pointer;
      user-select:none;
      background: rgba(255,255,255,.35);
      border:2px solid rgba(61,124,141,.10);
    }
    .swatch{
      width:22px; height:22px;
      border-radius:6px;
      border:2px solid rgba(0,0,0,.08);
      flex:0 0 auto;
    }
    .color-item .name{
      color:var(--title);
      font-size:18px;
      flex:1;
    }
    .mark{
      width:22px; height:22px;
      border-radius:6px;
      border:3px solid var(--btn);
      background:transparent;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      flex:0 0 auto;
    }
    .mark.on{ background: var(--btn); }
    .mark.on::after{
      content:"";
      width:10px; height:6px;
      border-left:3px solid var(--bg);
      border-bottom:3px solid var(--bg);
      transform: rotate(-45deg) translateY(-1px);
    }
    .modal-actions{
      display:flex;
      justify-content:flex-end;
      gap:10px;
      padding:10px 6px 2px;
    }
    .smallbtn{
      border:none;
      border-radius:12px;
      padding:10px 14px;
      font-size:18px;
      cursor:pointer;
      font-family:"Zen Kaku Gothic New", system-ui, -apple-system, sans-serif;
      font-weight:900;
    }
    .smallbtn.ok{ background: var(--btn); color: var(--bg); }
    .smallbtn.clear{ background: rgba(255,255,255,.35); color: var(--title); }
  </style>
</head>

<body>
  <header>© senamagu</header>

  <div class="wrap">
    <div class="hero">
      <h1>フィップス<br>キャラガチャ</h1>
      <div class="total">総数 <span id="totalCount">0</span>名</div>
    </div>

    <div class="cta">
      <button class="btn btn-gacha" id="btnGacha">ガチャる</button>
    </div>

    <div class="section-line"></div>

    <!-- 5 result card -->
    <div class="result-area">
      <div class="card" id="resultCard" style="display:none;">
        <div class="card-actions">
          <!-- 18資料 -->
          <button class="chip-btn" id="btnDoc" style="display:none;" title="資料">
            資料
          </button>
          <!-- 19共有 -->
          <button class="chip-btn" id="btnShare" title="共有">
            <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M16 7a3 3 0 1 0-2.83-4H13a3 3 0 0 0 3 4Zm-8 10a3 3 0 1 0 2.83 4H11a3 3 0 0 0-3-4Zm8-5a3 3 0 1 0 0-6 3 3 0 0 0 0 6ZM8.7 16.3l6.6-3.6m-6.6-5l6.6 3.6" stroke="#3D7C8D" stroke-width="2.2" stroke-linecap="round"/>
            </svg>
          </button>
          <!-- 19(追加)画像保存 -->
          <button class="chip-btn" id="btnSaveImg" title="画像として保存">
            保存
          </button>
        </div>

        <!-- left -->
        <div class="portrait" id="portraitBg">
          <div class="portrait-inner" id="portraitInner">
            <!-- img or no-image -->
          </div>

          <div class="nameblock">
            <div class="name-yomi" id="yomiText">—</div>
            <div class="name-divider"></div>
            <h2 class="name-main" id="nameText">—</h2>
          </div>
        </div>

        <!-- right -->
        <div class="info">
          <div class="series" id="seriesText"><small>創作</small><span id="seriesName">—</span></div>

          <div class="kv" id="kvArea">
            <!-- rows inserted -->
          </div>

          <div class="personality">
            <div class="k">性格</div>
            <div class="v" id="personalityText">未登録。</div>
          </div>
        </div>
      </div>
    </div>

    <div class="section-line"></div>

    <!-- 10 filters header -->
    <div class="filters-head">
      <div class="label">絞り込む</div>
      <button class="btn-reset" id="btnReset">リセット</button>
    </div>

    <div class="filters">
      <!-- 11/12/13 left -->
      <div class="filter-left">
        <!-- 11 multi -->
        <div class="field">
          <div class="k">創作タイトル</div>
          <div class="multi" data-multi="series">
            <div class="control multi-btn" role="button" tabindex="0">
              <span class="value placeholder">選択</span>
              <span class="caret"></span>
            </div>
            <div class="multi-panel"></div>
          </div>
        </div>

        <div class="field">
          <div class="k">キャラジャンル</div>
          <div class="multi" data-multi="genre">
            <div class="control multi-btn" role="button" tabindex="0">
              <span class="value placeholder">選択</span>
              <span class="caret"></span>
            </div>
            <div class="multi-panel"></div>
          </div>
        </div>

        <div class="field">
          <div class="k">性別</div>
          <div class="multi" data-multi="gender">
            <div class="control multi-btn" role="button" tabindex="0">
              <span class="value placeholder">選択</span>
              <span class="caret"></span>
            </div>
            <div class="multi-panel"></div>
          </div>
        </div>

        <!-- 12 range -->
        <div class="field">
          <div class="k">年齢</div>
          <div class="range-wrap">
            <input class="control" id="ageMin" inputmode="numeric" placeholder="最小" />
            <div class="sep">〜</div>
            <input class="control" id="ageMax" inputmode="numeric" placeholder="最大" />
          </div>
        </div>

        <div class="field">
          <div class="k">身長</div>
          <div class="range-wrap">
            <input class="control" id="hMin" inputmode="numeric" placeholder="最小" />
            <div class="sep">〜</div>
            <input class="control" id="hMax" inputmode="numeric" placeholder="最大" />
          </div>
        </div>

        <!-- 13 color -->
        <div class="field">
          <div class="k">イメージカラー</div>
          <div class="color-box" id="colorBox" title="タップで選択">
            <!-- 後で差し替え：ここに添付のホイール画像を置く -->
            <img src="https://github.com/senamagu/test.github.io/blob/main/tools/MAGOCgacha/Charamedia/colorwheel.PNG" alt="color wheel" id="colorWheelImg">
            <div class="color-sel" id="colorSelText">
              <span class="placeholder" style="color:var(--placeholder);">選択</span>
            </div>
          </div>
        </div>
      </div>

      <!-- 14/15/16 right -->
      <div class="filter-right">
        <div class="toggle" id="tglHasImage">
          <span class="radio on" id="dotHasImage"></span>
          <span>画像ありのみ</span>
        </div>

        <div class="toggle" id="tglHasDoc">
          <span class="radio" id="dotHasDoc"></span>
          <span>資料ありのみ</span>
        </div>

        <div class="hits">
          <span>ヒット件数</span>
          <span id="hitCount">0</span><span>名</span>
        </div>

        <div class="hitlist">
          <div class="hitgrid" id="hitGrid"></div>
        </div>
      </div>
    </div>

    <div class="bottom">
      <button class="btn-list" id="btnList">キャラ一覧へ</button>
    </div>
  </div>

  <!-- color modal -->
  <div class="modal" id="colorModal" aria-hidden="true">
    <div class="modal-panel">
      <div class="modal-title">
        <span>カラーを選択</span>
        <button class="xbtn" id="btnCloseColor" aria-label="close">×</button>
      </div>
      <div class="color-grid" id="colorGrid"></div>
      <div class="modal-actions">
        <button class="smallbtn clear" id="btnClearColor">クリア</button>
        <button class="smallbtn ok" id="btnOkColor">OK</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    /**********************
     * DATA
     **********************/
    // gender: "male" | "female" | "other"
    // genre: "人間" など自由
    // tags: ["棒人間","ケモ"] など自由
    // color: "#34C38E" or null
    // colorTag: "赤/青/緑/..."（13の色絞り込み用：難しければこれで運用）
    // image: "Charamedia/xxx.png"（相対パス）
    // docUrl: "https://..."（18）
    // shareQuote: "飯が美味いぜ！"（19）
    const characters = [
      {
        id:"asano_sana",
        name:"浅野 醒那",
        yomi:"アサノ サナ",
        series:"描楽幻想街",
        gender:"female",
        age:21,
        heightCm:158,
        birthday:"11/11",
        personality:"元気！\n超元気だよ！\nじゃがりこ好きだよ！",
        color:"#34C38E",
        colorTag:"緑",
        genre:"人間",
        tags:["人間"],
        image:"sanpul.png",
        docUrl:"https://x.com/senamagu_cs/status/1876245564683432232?s=46",
        shareQuote:"飯が美味いぜ！"
      },
      {
        id:"sample_noimg",
        name:"椎野 明",
        yomi:"シイノ アキラ",
        series:"描楽幻想街",
        gender:"male",
        age:19,
        heightCm:172,
        birthday:"",
        personality:"",
        color:"#F37679",
        colorTag:"ピンク",
        genre:"人間",
        tags:["人間"],
        image:"",
        docUrl:"",
        shareQuote:"今日はツイてるな。"
      },
      {
        id:"sample_other",
        name:"音楽 奏太郎",
        yomi:"オンガク ソウタロウ",
        series:"フィップス",
        gender:"other",
        age:null,
        heightCm:null,
        birthday:"",
        personality:"未登録。",
        color:"",
        colorTag:"青",
        genre:"棒人間",
        tags:["棒人間"],
        image:"",
        docUrl:"",
        shareQuote:"よろしく。"
      }
    ];

    // 13 color list
    const COLOR_ITEMS = [
      {key:"赤",   hex:"#F25C5C"},
      {key:"青",   hex:"#4F90FF"},
      {key:"緑",   hex:"#34C38E"},
      {key:"黄色", hex:"#D9D84B"},
      {key:"オレンジ", hex:"#F39A3E"},
      {key:"ピンク", hex:"#F37679"},
      {key:"紫",   hex:"#8C6BFF"},
      {key:"茶色", hex:"#9B6B5B"},
      {key:"黒",   hex:"#222222"},
      {key:"白",   hex:"#FFFFFF"},
      {key:"灰色", hex:"#9AA6AA"}
    ];

    /**********************
     * STATE
     **********************/
    const state = {
      selectedSeries: new Set(),
      selectedGenres: new Set(),
      selectedGenders: new Set(),
      ageMin: null,
      ageMax: null,
      hMin: null,
      hMax: null,
      selectedColors: new Set(), // uses colorTag
      hasImageOnly: true, // 14 initial: 画像ありのみが選択状態
      hasDocOnly: false,
      lastResult: null
    };

    /**********************
     * HELPERS
     **********************/
    const $ = (sel)=>document.querySelector(sel);
    const toast = (msg)=>{
      const el = $("#toast");
      el.textContent = msg;
      el.classList.add("show");
      clearTimeout(toast._t);
      toast._t = setTimeout(()=>el.classList.remove("show"), 1600);
    };

    const normNum = (v)=>{
      if(v===null || v===undefined) return null;
      const s = String(v).trim();
      if(!s) return null;
      const n = Number(s);
      return Number.isFinite(n) ? n : null;
    };

    // JSで文字を横幅にフィット
    function fitTextToWidth(el, maxPx, minPx){
      if(!el) return;
      el.style.fontSize = maxPx + "px";
      const parent = el.parentElement;
      const targetW = parent ? parent.clientWidth : el.clientWidth;
      // 少し余裕
      const limitW = Math.max(0, targetW - 8);
      let size = maxPx;
      // ざっくりループ（短いのでOK）
      while(size > minPx && el.scrollWidth > limitW){
        size -= 1;
        el.style.fontSize = size + "px";
      }
    }

    function genderLabel(g){
      if(g==="male") return "男性";
      if(g==="female") return "女性";
      return "その他";
    }

    function hasValue(v){
      return v!==null && v!==undefined && String(v).trim()!=="";
    }

    /**********************
     * FILTERING
     **********************/
    function applyFilters(){
      const aMin = state.ageMin, aMax = state.ageMax;
      const hMin = state.hMin, hMax = state.hMax;

      const res = characters.filter(c=>{
        // 11 series multi
        if(state.selectedSeries.size){
          if(!state.selectedSeries.has(c.series)) return false;
        }
        // 11 genre multi (キャラジャンル)
        if(state.selectedGenres.size){
          if(!state.selectedGenres.has(c.genre)) return false;
        }
        // 11 gender multi
        if(state.selectedGenders.size){
          if(!state.selectedGenders.has(c.gender)) return false;
        }

        // 12 age range
        if(aMin!==null || aMax!==null){
          if(!Number.isFinite(c.age)) return false;
          if(aMin!==null && c.age < aMin) return false;
          if(aMax!==null && c.age > aMax) return false;
        }
        // 12 height range
        if(hMin!==null || hMax!==null){
          if(!Number.isFinite(c.heightCm)) return false;
          if(hMin!==null && c.heightCm < hMin) return false;
          if(hMax!==null && c.heightCm > hMax) return false;
        }

        // 13 colors (colorTag)
        if(state.selectedColors.size){
          if(!hasValue(c.colorTag)) return false;
          if(!state.selectedColors.has(c.colorTag)) return false;
        }

        // 14 has image/doc
        if(state.hasImageOnly){
          if(!hasValue(c.image)) return false;
        }
        if(state.hasDocOnly){
          if(!hasValue(c.docUrl)) return false;
        }

        return true;
      });

      renderHit(res);
      return res;
    }

    /**********************
     * RENDER - HIT LIST (15/16)
     **********************/
    function renderHit(list){
      $("#hitCount").textContent = list.length;

      const grid = $("#hitGrid");
      grid.innerHTML = "";
      for(const c of list){
        const div = document.createElement("div");
        div.className = "hitname";
        div.textContent = c.name;
        grid.appendChild(div);
      }
    }

    /**********************
     * RENDER - MULTI SELECT
     **********************/
    function uniqueValues(key){
      const set = new Set();
      for(const c of characters){
        if(key==="series") set.add(c.series);
        if(key==="genre") set.add(c.genre);
        if(key==="gender") set.add(c.gender);
      }
      return [...set].filter(Boolean);
    }

    function renderMulti(multiEl){
      const kind = multiEl.dataset.multi;
      const panel = multiEl.querySelector(".multi-panel");
      panel.innerHTML = "";

      const values = uniqueValues(kind).sort((a,b)=>String(a).localeCompare(String(b),"ja"));
      const currentSet =
        kind==="series" ? state.selectedSeries :
        kind==="genre"  ? state.selectedGenres :
        kind==="gender" ? state.selectedGenders :
        new Set();

      for(const v of values){
        const row = document.createElement("div");
        row.className = "opt";
        const tick = document.createElement("span");
        tick.className = "tick" + (currentSet.has(v) ? " on":"");
        const label = document.createElement("span");
        label.textContent = (kind==="gender") ? genderLabel(v) : v;

        row.appendChild(tick);
        row.appendChild(label);

        row.addEventListener("click", ()=>{
          if(currentSet.has(v)) currentSet.delete(v);
          else currentSet.add(v);
          renderMulti(multiEl);
          updateMultiValueText(multiEl);
          applyFilters();
        });

        panel.appendChild(row);
      }

      updateMultiValueText(multiEl);
    }

    function updateMultiValueText(multiEl){
      const kind = multiEl.dataset.multi;
      const valEl = multiEl.querySelector(".value");

      const set =
        kind==="series" ? state.selectedSeries :
        kind==="genre"  ? state.selectedGenres :
        kind==="gender" ? state.selectedGenders :
        new Set();

      if(!set.size){
        valEl.textContent = "選択";
        valEl.classList.add("placeholder");
        return;
      }
      const arr = [...set].map(v=> kind==="gender" ? genderLabel(v) : v);
      valEl.textContent = arr.join("、");
      valEl.classList.remove("placeholder");
    }

    function setupMulti(){
      document.querySelectorAll(".multi").forEach(m=>{
        renderMulti(m);
        const btn = m.querySelector(".multi-btn");
        btn.addEventListener("click", ()=>{
          // close others
          document.querySelectorAll(".multi").forEach(x=>{ if(x!==m) x.classList.remove("open"); });
          m.classList.toggle("open");
        });
        btn.addEventListener("keydown", (e)=>{
          if(e.key==="Enter" || e.key===" "){
            e.preventDefault();
            btn.click();
          }
        });
      });

      // click outside closes
      document.addEventListener("click", (e)=>{
        const inside = e.target.closest(".multi");
        if(!inside){
          document.querySelectorAll(".multi").forEach(x=>x.classList.remove("open"));
        }
      });
    }

    /**********************
     * 13 COLOR MODAL
     **********************/
    let tempColors = new Set();

    function openColorModal(){
      tempColors = new Set(state.selectedColors);
      renderColorGrid();
      $("#colorModal").classList.add("open");
    }
    function closeColorModal(){
      $("#colorModal").classList.remove("open");
    }
    function renderColorGrid(){
      const grid = $("#colorGrid");
      grid.innerHTML = "";
      for(const item of COLOR_ITEMS){
        const row = document.createElement("div");
        row.className = "color-item";
        const sw = document.createElement("span");
        sw.className = "swatch";
        sw.style.background = item.hex;

        const name = document.createElement("div");
        name.className = "name";
        name.textContent = item.key;

        const mark = document.createElement("span");
        mark.className = "mark" + (tempColors.has(item.key) ? " on":"");

        row.appendChild(sw);
        row.appendChild(name);
        row.appendChild(mark);

        row.addEventListener("click", ()=>{
          if(tempColors.has(item.key)) tempColors.delete(item.key);
          else tempColors.add(item.key);
          renderColorGrid();
        });

        grid.appendChild(row);
      }
    }

    function renderColorSelText(){
      const box = $("#colorSelText");
      box.innerHTML = "";
      if(!state.selectedColors.size){
        const sp = document.createElement("span");
        sp.textContent = "選択";
        sp.style.color = getComputedStyle(document.documentElement).getPropertyValue("--placeholder");
        box.appendChild(sp);
        return;
      }
      for(const k of state.selectedColors){
        const pill = document.createElement("span");
        pill.className = "pill";
        pill.textContent = k;
        box.appendChild(pill);
      }
    }

    /**********************
     * 14 toggles
     **********************/
    function setToggle(elDot, on){
      elDot.classList.toggle("on", !!on);
    }

    /**********************
     * 5-9 RESULT RENDER
     **********************/
    function renderResult(c){
      state.lastResult = c;

      const card = $("#resultCard");
      card.style.display = "grid";

      // 6 portrait bg depends on color code
      const bg = hasValue(c.color) ? c.color : "#89AFB9";
      $("#portraitBg").style.background = bg;

      // image area
      const inner = $("#portraitInner");
      inner.innerHTML = "";
      if(hasValue(c.image)){
        const img = document.createElement("img");
        img.src = c.image;
        img.alt = c.name;
        inner.appendChild(img);
      }else{
        inner.style.background = "#89AFB9";
        const div = document.createElement("div");
        div.className = "no-image";
        div.textContent = "画像なし";
        inner.appendChild(div);
      }

      // 7 names
      $("#nameText").textContent = c.name || "—";
      $("#yomiText").textContent = hasValue(c.yomi) ? c.yomi : "—";

      // 8 series
      $("#seriesName").textContent = c.series || "—";
      // 8 fit
      fitTextToWidth($("#seriesText"), 44, 22);

      // 9 kv rows: 性別〜カラーコード
      const kv = $("#kvArea");
      kv.innerHTML = "";

      const rows = [
        ["性別", hasValue(c.gender) ? genderLabel(c.gender) : "未登録。"],
        ["年齢", Number.isFinite(c.age) ? (c.age + "歳") : "未登録。"],
        ["身長", Number.isFinite(c.heightCm) ? (c.heightCm + "cm") : "未登録。"],
        ["誕生日", hasValue(c.birthday) ? c.birthday : "未登録。"],
        ["カラーコード", hasValue(c.color) ? c.color : "未登録。"]
      ];

      for(let i=0;i<rows.length;i++){
        const [k,v] = rows[i];
        const kEl = document.createElement("div");
        kEl.className = "k";
        kEl.textContent = k;
        const vEl = document.createElement("div");
        vEl.className = "v";
        vEl.textContent = v;

        kv.appendChild(kEl);
        kv.appendChild(vEl);

        // divider lines between rows
        if(i !== rows.length-1){
          const line = document.createElement("div");
          line.className = "kv-line";
          kv.appendChild(line);
        }
      }

      // personality 3 lines max + 未登録
      const p = hasValue(c.personality) ? c.personality : "未登録。";
      $("#personalityText").textContent = p;

      // 7 fit name to same width
      fitTextToWidth($("#nameText"), 52, 22);
      // also yomi slightly (optional)
      // fitTextToWidth($("#yomiText"), 20, 14);

      // 18 doc button
      const btnDoc = $("#btnDoc");
      if(hasValue(c.docUrl)){
        btnDoc.style.display = "flex";
        btnDoc.onclick = ()=> window.open(c.docUrl, "_blank", "noopener");
      }else{
        btnDoc.style.display = "none";
      }
    }

    /**********************
     * 19 SHARE
     **********************/
    function buildShareText(c){
      const base = `あなたはフィップスキャラガチャで${c.name}を出しました！`;
      const quote = hasValue(c.shareQuote) ? ` ${c.name}「${c.shareQuote}」` : "";
      return base + quote;
    }

    async function shareResult(){
      const c = state.lastResult;
      if(!c) return;
      const text = buildShareText(c);

      // Web Share
      if(navigator.share){
        try{
          await navigator.share({ text });
          return;
        }catch(e){
          // cancel ok
        }
      }
      // fallback copy
      try{
        await navigator.clipboard.writeText(text);
        toast("共有文をコピーした");
      }catch(e){
        toast("コピーできなかった");
      }
    }

    /**********************
     * 19 SAVE CARD IMAGE
     **********************/
    async function saveCardImage(){
      const card = $("#resultCard");
      if(card.style.display==="none"){
        toast("先にガチャってくれ");
        return;
      }
      if(typeof html2canvas !== "function"){
        toast("画像保存が使えない（html2canvasなし）");
        return;
      }
      try{
        const canvas = await html2canvas(card, {backgroundColor:null, scale:2});
        const a = document.createElement("a");
        a.download = "gacha_result.png";
        a.href = canvas.toDataURL("image/png");
        a.click();
      }catch(e){
        toast("画像保存に失敗した");
      }
    }

    /**********************
     * INIT + EVENTS
     **********************/
    function updateCounts(){
      $("#totalCount").textContent = characters.length;
    }

    function wireInputs(){
      // 12 ranges
      const ageMin = $("#ageMin"), ageMax = $("#ageMax");
      const hMin = $("#hMin"), hMax = $("#hMax");

      const onRangeChange = ()=>{
        state.ageMin = normNum(ageMin.value);
        state.ageMax = normNum(ageMax.value);
        state.hMin = normNum(hMin.value);
        state.hMax = normNum(hMax.value);
        applyFilters();
      };
      [ageMin,ageMax,hMin,hMax].forEach(el=>{
        el.addEventListener("input", onRangeChange);
        el.addEventListener("change", onRangeChange);
      });

      // 13 color modal open
      $("#colorBox").addEventListener("click", openColorModal);
      $("#btnCloseColor").addEventListener("click", closeColorModal);
      $("#colorModal").addEventListener("click", (e)=>{
        if(e.target.id==="colorModal") closeColorModal();
      });
      $("#btnClearColor").addEventListener("click", ()=>{
        tempColors.clear();
        renderColorGrid();
      });
      $("#btnOkColor").addEventListener("click", ()=>{
        state.selectedColors = new Set(tempColors);
        renderColorSelText();
        closeColorModal();
        applyFilters();
      });

      // 14 toggles
      $("#tglHasImage").addEventListener("click", ()=>{
        state.hasImageOnly = !state.hasImageOnly;
        setToggle($("#dotHasImage"), state.hasImageOnly);
        applyFilters();
      });
      $("#tglHasDoc").addEventListener("click", ()=>{
        state.hasDocOnly = !state.hasDocOnly;
        setToggle($("#dotHasDoc"), state.hasDocOnly);
        applyFilters();
      });

      // 4 gacha
      $("#btnGacha").addEventListener("click", ()=>{
        const pool = applyFilters();
        if(!pool.length){
          toast("ヒット0件。絞り込みを変えて");
          return;
        }
        const pick = pool[Math.floor(Math.random()*pool.length)];
        renderResult(pick);
      });

      // 18/19
      $("#btnShare").addEventListener("click", shareResult);
      $("#btnSaveImg").addEventListener("click", saveCardImage);

      // 17 list button (未準備なのでポップ)
      $("#btnList").addEventListener("click", ()=>{
        toast("準備中");
      });

      // 10 reset
      $("#btnReset").addEventListener("click", ()=>{
        state.selectedSeries.clear();
        state.selectedGenres.clear();
        state.selectedGenders.clear();
        state.ageMin = state.ageMax = state.hMin = state.hMax = null;
        state.selectedColors.clear();
        state.hasImageOnly = true;
        state.hasDocOnly = false;

        $("#ageMin").value = "";
        $("#ageMax").value = "";
        $("#hMin").value = "";
        $("#hMax").value = "";

        setToggle($("#dotHasImage"), state.hasImageOnly);
        setToggle($("#dotHasDoc"), state.hasDocOnly);

        document.querySelectorAll(".multi").forEach(m=>{
          renderMulti(m);
          updateMultiValueText(m);
          m.classList.remove("open");
        });

        renderColorSelText();
        applyFilters();
        toast("リセットした");
      });
    }

    function init(){
      updateCounts();
      setupMulti();
      renderColorSelText();
      setToggle($("#dotHasImage"), state.hasImageOnly);
      setToggle($("#dotHasDoc"), state.hasDocOnly);

      // 初期ヒット
      applyFilters();

      wireInputs();
    }

    init();
  </script>
</body>
</html>
